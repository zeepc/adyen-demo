{"version":3,"file":"Script.js","sources":["../../../src/utils/Script.ts"],"sourcesContent":["import AdyenCheckoutError from '../core/Errors/AdyenCheckoutError';\nimport { AnalyticsInfoEvent, InfoEventType } from '../core/Analytics/events/AnalyticsInfoEvent';\nimport type { IAnalytics } from '../core/Analytics/Analytics';\n\ninterface IScript {\n    load(): Promise<void>;\n    remove(): void;\n}\n\ninterface IScriptProps {\n    src: string;\n    component: string;\n    analytics: IAnalytics;\n    node?: string;\n    attributes?: Partial<HTMLScriptElement>;\n    dataAttributes?: Record<string, string | undefined>;\n}\n\n// Returns Base URL of the resource without any query parameters (e.g. merchant ID, token, etc). Used for Analytics\nfunction getBaseURL(src: string): string {\n    const url = new URL(src);\n    return url.origin + url.pathname;\n}\n\nclass Script implements IScript {\n    private readonly src: string;\n    private readonly component: string;\n    private readonly node: string;\n    private readonly attributes: Partial<HTMLScriptElement>;\n    private readonly dataAttributes: Record<string, string | undefined>;\n    private readonly analytics: IAnalytics;\n    private readonly baseUrl: string;\n\n    private script: HTMLScriptElement;\n    private loadPromise: Promise<void> | null = null;\n    private rejectLoadPromise: (reason?: any) => void | null = null;\n    private resolveLoadScript: (() => void) | null = null;\n    private rejectLoadScript: ((reason?: any) => void) | null = null;\n\n    private readonly handleOnLoad = () => {\n        this.script?.setAttribute('data-script-loaded', 'true');\n        this.cleanupListeners();\n        this.resolveLoadScript?.();\n    };\n\n    private readonly handleOnError = (errorEvent: ErrorEvent) => {\n        this.cleanupListeners();\n        const error = new AdyenCheckoutError(\n            'SCRIPT_ERROR',\n            `Unable to load script ${this.src}.${errorEvent?.message && `Message: ${errorEvent.message}`}`,\n            {\n                cause: errorEvent?.error || errorEvent\n            }\n        );\n        this.rejectLoadScript?.(error);\n    };\n\n    public static readonly RETRY_DELAY = 1000;\n    public static readonly MAX_NUMBER_OF_RETRIES = 3;\n\n    constructor({ src, component, node = 'body', attributes, dataAttributes, analytics }: IScriptProps) {\n        this.src = src;\n        this.component = component;\n        this.node = node;\n        this.attributes = attributes;\n        this.dataAttributes = dataAttributes;\n        this.analytics = analytics;\n        this.baseUrl = getBaseURL(this.src);\n    }\n\n    public load = (): Promise<void> => {\n        if (this.loadPromise !== null) {\n            if (process.env.NODE_ENV === 'development') console.warn(`[Warning] script.load called more than once for ${this.src}`);\n            return this.loadPromise;\n        }\n\n        this.loadPromise = new Promise((resolve, reject) => {\n            this.rejectLoadPromise = reject;\n            let attempts = 0;\n\n            this.trackEvent(InfoEventType.sdkDownloadInitiated);\n\n            const loadScriptWithRetry = async (): Promise<void> => {\n                try {\n                    attempts++;\n                    await this.loadScript();\n                    this.trackEvent(InfoEventType.sdkDownloadCompleted);\n                    resolve();\n                } catch (error: unknown) {\n                    if (this.loadPromise === null) {\n                        return;\n                    }\n\n                    this.trackEvent(InfoEventType.sdkDownloadFailed);\n\n                    this.removeScript();\n\n                    if (attempts < Script.MAX_NUMBER_OF_RETRIES) {\n                        setTimeout(() => void loadScriptWithRetry(), Script.RETRY_DELAY);\n                    } else {\n                        this.trackEvent(InfoEventType.sdkDownloadAborted);\n                        this.loadPromise = null;\n                        this.rejectLoadPromise = null;\n                        reject(error);\n                    }\n                }\n            };\n\n            void loadScriptWithRetry();\n        });\n\n        return this.loadPromise;\n    };\n\n    public remove = () => {\n        this.rejectLoadPromise?.(new AdyenCheckoutError('CANCEL', 'Script loading cancelled.'));\n        this.removeScript();\n        this.loadPromise = null;\n    };\n\n    private removeScript() {\n        this.cleanupListeners();\n        this.script?.parentNode?.removeChild(this.script);\n        this.script = null;\n    }\n\n    private cleanupListeners() {\n        if (!this.script) return;\n        this.script.removeEventListener('load', this.handleOnLoad);\n        this.script.removeEventListener('error', this.handleOnError);\n    }\n\n    private attachListeners() {\n        if (!this.script) return;\n        this.cleanupListeners();\n        this.script.addEventListener('load', this.handleOnLoad);\n        this.script.addEventListener('error', this.handleOnError);\n    }\n\n    private loadScript(): Promise<void> {\n        return new Promise((resolve, reject) => {\n            const scriptContainer = document.querySelector(this.node);\n\n            if (!scriptContainer) {\n                reject(new AdyenCheckoutError('SCRIPT_ERROR', `Unable to find script container node: ${this.node}`));\n                return;\n            }\n\n            this.resolveLoadScript = resolve;\n            this.rejectLoadScript = reject;\n\n            this.script = scriptContainer.querySelector(`script[src=\"${this.src}\"]`);\n\n            // Script element exists in the browser and is already loaded\n            if (this.script?.getAttribute('data-script-loaded')) {\n                this.resolveLoadScript();\n                return;\n            }\n\n            // Script element exists in the browser, but it is not loaded yet\n            // Use-case:  Multiple PayPal standalone components being loaded in different parts of the screen.\n            if (this.script) {\n                this.attachListeners();\n                return;\n            }\n\n            // Script element doesn't exist in the browser, so we create it and append to the DOM tree\n            this.script = document.createElement('script');\n\n            Object.assign(this.script, this.attributes);\n            Object.assign(this.script.dataset, this.dataAttributes);\n\n            this.script.src = this.src;\n            this.script.async = true;\n\n            this.attachListeners();\n\n            scriptContainer.appendChild(this.script);\n        });\n    }\n\n    private trackEvent(eventType: InfoEventType) {\n        const event = new AnalyticsInfoEvent({\n            type: eventType,\n            component: this.component,\n            cdnUrl: this.baseUrl\n        });\n        this.analytics?.sendAnalytics(event);\n    }\n}\n\nexport default Script;\n"],"names":["Script","removeScript","this","cleanupListeners","script","parentNode","removeChild","removeEventListener","handleOnLoad","handleOnError","attachListeners","addEventListener","loadScript","Promise","resolve","reject","scriptContainer","document","querySelector","node","resolveLoadScript","rejectLoadScript","src","getAttribute","createElement","Object","assign","attributes","dataset","dataAttributes","async","appendChild","AdyenCheckoutError","trackEvent","eventType","event","AnalyticsInfoEvent","type","component","cdnUrl","baseUrl","analytics","sendAnalytics","constructor","_define_property","loadPromise","rejectLoadPromise","setAttribute","errorEvent","error","message","cause","load","attempts","InfoEventType","sdkDownloadInitiated","loadScriptWithRetry","sdkDownloadCompleted","sdkDownloadFailed","MAX_NUMBER_OF_RETRIES","setTimeout","RETRY_DELAY","sdkDownloadAborted","remove","url","URL","origin","pathname","getBaseURL"],"mappings":"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"}