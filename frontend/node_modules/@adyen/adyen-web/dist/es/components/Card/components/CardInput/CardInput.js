import{createElement as e,Fragment as r}from"../../../../external/preact/dist/preact.js";import{useRef as t,useMemo as o,useState as n,useCallback as s,useEffect as a}from"../../../../external/preact/hooks/dist/hooks.js";import i from"../../../internal/SecuredFields/SFP/SecuredFieldsProvider.js";import l from"./defaultProps.js";import{AddressModeOptions as d}from"./types.js";import{ENCRYPTED_CARD_NUMBER as u,DATE_POLICY_REQUIRED as c,CVC_POLICY_REQUIRED as m}from"../../../internal/SecuredFields/lib/constants.js";import{cardInputValidationRules as p,getRuleByNameAndMode as y,cardInputFormatters as f}from"./validate.js";import h from"../../../internal/SecuredFields/binLookup/extensions.js";import b from"../../../../utils/useForm/useForm.js";import{handlePartialAddressMode as S,extractPropsForSFP as g,extractPropsForCardFields as N,getLayout as A}from"./utils.js";import F from"../../../internal/Address/Specifications.js";import{StoredCardFieldsWrapper as C}from"./components/StoredCardFieldsWrapper.js";import{CardFieldsWrapper as j}from"./components/CardFieldsWrapper.js";import{getAutoJumpHandler as v,getFocusHandler as B,getAddressHandler as k}from"./handlers.js";import w from"../../../../_virtual/index.js";import{getPartialAddressValidationRules as R}from"../../../internal/Address/validate.js";import x from"../../../../core/Context/useImage.js";import{getArrayDifferences as E}from"../../../../utils/arrayUtils.js";import I from"../../../internal/FormInstruction/FormInstruction.js";import{PREFIX as P}from"../../../internal/Icon/constants.js";import V from"./useSRPanelForCardInputErrors.js";import O from"../Fastlane/FastlaneSignup.js";import{fieldTypeToSnakeCase as q}from"../../../internal/SecuredFields/utils.js";import{getErrorMessageFromCode as D}from"../../../../core/Errors/utils.js";import{SF_ErrorCodes as M}from"../../../../core/Errors/constants.js";import{usePrevious as _}from"../../../../utils/hookUtils.js";import{AnalyticsInfoEvent as L,InfoEventType as T,UiTarget as K}from"../../../../core/Analytics/events/AnalyticsInfoEvent.js";const U=l=>{const U=t(null),H=t(!1),z=x(),W=t(null),$=e=>{W.current=e},G=t({});Object.keys(G.current).length||l.setComponentRef(G.current);const J=t(0),Q=t(!1),X=o(()=>new F(l.specifications),[l.specifications]);G.current.sfp=U;const[Y,Z]=n("ready"),[ee,re]=n({}),[te,oe]=n({...l.holderNameRequired&&{holderName:!1}}),[ne,se]=n({...l.hasHolderName&&{holderName:l.data.holderName??""}}),[ae,ie]=n(""),[le,de]=n(!1),[ue,ce]=n(c),[me,pe]=n(m),[ye,fe]=n(null),[he,be]=n([]),[Se,ge]=n(l.storedPaymentMethodId?l.brand:""),Ne=l.billingAddressMode!==d.none&&l.billingAddressRequired,Ae=S(l.billingAddressMode),Fe=t(Ae&&l.data?.billingAddress?.country),[Ce,je]=n(!1),[ve,Be]=n(Ne?l.data.billingAddress:null),[ke,we]=n(!1),[Re,xe]=n(""),[Ee,Ie]=n({value:null}),[Pe,Ve]=n(null),[Oe,qe]=n("card"),[De,Me]=n(!1),{handleChangeFor:_e,triggerValidation:Le,data:Te,valid:Ke,errors:Ue,setSchema:He,setData:ze,setValid:We,setErrors:$e}=b({schema:[],defaultData:l.data,formatters:f,rules:p}),Ge=!(!Object.keys(l.installmentOptions).length||l.fundingSource&&"credit"!==l.fundingSource),Je=l.showInstallmentAmounts??!0,Qe="kr"===(ye??l.countryCode),Xe=l.configuration.koreanAuthenticationRequired&&Qe,Ye=ke&&"auto"===l.configuration.socialSecurityNumberMode||"show"===l.configuration.socialSecurityNumberMode,Ze=(e,r)=>{l.onFocus({fieldType:e,event:r})},er=(e,r)=>{l.onBlur({fieldType:e,event:r})},rr=s(e=>{qe(e.brand),l.onBrand(e)},[]),tr=B(ie,Ze,er),or=()=>A({props:l,showKCP:Xe,showBrazilianSSN:Ye,...l.billingAddressRequired&&{countrySpecificSchemas:X.getAddressSchemaForCountry(ve?.country),billingAddressRequiredFields:l.billingAddressRequiredFields}}),nr=s(e=>{const r="webInternalElement"!==e.fieldType?e.fieldType:e.name;Ve(r)},[]),sr=k(ze,We,$e),ar=v(Q,U,or()),ir=s(e=>{lr(e)},[De,Me]),lr=e=>{e.status&&("loading"==e.status?Me(!1):Me(!0))},dr=o(()=>h(l,{sfp:U},{dualBrandSelectElements:he,setDualBrandSelectElements:be,setSelectedBrandValue:ge,issuingCountryCode:ye,setIssuingCountryCode:fe},J),[he,ye]);G.current.showValidation=()=>{H.current=!0,mr?.(),U.current.showValidation(),Le(["holderName","socialSecurityNumber","taxNumber"]),W?.current&&W.current.showValidation()},G.current.processBinLookupResponse=(e,r)=>{dr.processBinLookup(e,r)},G.current.setStatus=Z,a(()=>(G.current.setFocusOn=U.current.setFocusOn,G.current.updateStyles=U.current.updateStyles,G.current.handleUnsupportedCard=U.current.handleUnsupportedCard,()=>{U.current.destroy()}),[]),a(()=>{const e=[...l.hasHolderName?["holderName"]:[],...Ye?["socialSecurityNumber"]:[],...Xe?["taxNumber"]:[],...Ne?["billingAddress"]:[]];He(e)},[l.hasHolderName,Ye,Xe]),a(()=>{se({...ne,holderName:Te.holderName??"",taxNumber:Te.taxNumber}),xe(Te.socialSecurityNumber),Ne&&Be({...Te.billingAddress}),oe({...te,holderName:!l.holderNameRequired||Ke.holderName,socialSecurityNumber:!!Ke.socialSecurityNumber&&Ke.socialSecurityNumber,taxNumber:!!Ke.taxNumber&&Ke.taxNumber,billingAddress:!!Ke.billingAddress&&Ke.billingAddress});const e=!!Ue.billingAddress&&Object.entries(Ue.billingAddress).reduce((e,[,r])=>e||null!=r,!1);re({...ee,holderName:l.holderNameRequired&&Ue.holderName?Ue.holderName:null,socialSecurityNumber:Ye&&Ue.socialSecurityNumber?Ue.socialSecurityNumber:null,taxNumber:Xe&&Ue.taxNumber?Ue.taxNumber:null,billingAddress:Ne&&e?Ue.billingAddress:null})},[Te,Ke,Ue]);const{sortedErrorList:ur,previousSortedErrors:cr,clearSRPanel:mr}=V({errors:ee,props:l,isValidating:H,retrieveLayout:or,specifications:X,billingAddress:ve,sfp:U});a(()=>{if(ur){const e=E(ur,cr,"field");e?.forEach(e=>{const r=new L({component:l.type,type:T.validationError,target:q(e.field),validationErrorCode:e.errorCode,validationErrorMessage:D(e.errorCode,M)});l.onSubmitAnalytics(r)})}},[ur]),a(()=>{const e=te.holderName,r=le,t=!Ne||te.billingAddress,o=!Xe||!!te.taxNumber&&!!te.encryptedPassword,n=!Ye||!!te.socialSecurityNumber,s=r&&e&&t&&o&&n,a=U.current.mapErrorsToValidationRuleResult(),i={...ee,...a};l.onChange({data:ne,valid:te,errors:i,isValid:s,billingAddress:ve,selectedBrandValue:Se,storePaymentMethod:Ce,socialSecurityNumber:Re,installments:Ee})},[ne,te,ee,Se,Ce,Ee]),a(()=>{if(he.length>0&&he){const e=he.map(e=>e.id),r=e[0],t=e.toString(),o=new L({component:l.type,type:T.displayed,target:K.dualBrandButton,brand:r,configData:{dualBrands:t}});l.onSubmitAnalytics(o)}},[he]);const pr=_(Se);a(()=>{if(pr?.length&&Se?.length){const e=new L({component:l.type,type:T.selected,target:K.dualBrandButton,brand:Se});l.onSubmitAnalytics(e)}},[Se]);const yr=l.storedPaymentMethodId?C:j;return e(r,null,e(i,{ref:U,...g(l),styles:{...l.styles},koreanAuthenticationRequired:l.configuration.koreanAuthenticationRequired,hasKoreanFields:!(!l.configuration.koreanAuthenticationRequired||"kr"!==l.countryCode),onSubmitAnalytics:l.onSubmitAnalytics,onChange:(e,r)=>{if(e.autoCompleteName){if(!l.hasHolderName)return;const r=y("holderName","blur")(e.autoCompleteName)?e.autoCompleteName:null;return void(r&&(ze("holderName",r),We("holderName",!0),$e("holderName",null)))}l.autoFocus&&J.current>0&&"handleOnFieldValid"===r?.event&&r?.fieldType===u&&e.valid.encryptedCardNumber&&ar(),se({...ne,...e.data}),re({...ee,...e.errors}),oe({...te,...e.valid}),de(e.isSfpValid),pe(e.cvcPolicy),we(e.showSocialSecurityNumber),ce(e.expiryDatePolicy)},onBrand:rr,onFocus:tr,onStateUpdate:ir,type:l.brand,componentType:l.type,disableIOSArrowKeys:l.disableIOSArrowKeys?nr:null,render:({setRootNode:r,setFocusOn:t},o)=>e("div",{ref:r,className:w({"adyen-checkout__card-input":!0,"adyen-checkout-card-input__wrapper":!0,[`adyen-checkout__card-input--${l.fundingSource??"credit"}`]:!0,"adyen-checkout__card-input--loading":"loading"===Y}),role:"form"},De&&e(I,null),e(yr,{...N(l),data:ne,valid:te,errors:ee,handleChangeFor:_e,focusedElement:ae,setFocusOn:t,sfpState:o,cvcPolicy:me,hasInstallments:Ge,showAmountsInInstallments:Je,handleInstallments:Ie,brandsIcons:l.brandsIcons,formData:Te,formErrors:Ue,formValid:Ke,expiryDatePolicy:ue,dualBrandSelectElements:he,extensions:dr,selectedBrandValue:Se,showKCP:Xe,showBrazilianSSN:Ye,socialSecurityNumber:Re,handleOnStoreDetails:je,setAddressRef:$,billingAddress:ve,billingAddressValidationRules:Ae&&R(Fe.current),partialAddressSchema:Ae,handleAddress:sr,onAddressLookup:l.onAddressLookup,onAddressSelected:l.onAddressSelected,addressSearchDebounceMs:l.addressSearchDebounceMs,iOSFocusedField:Pe,onFieldFocusAnalytics:Ze,onFieldBlurAnalytics:er}))}),l.fastlaneConfiguration&&e(O,{...l.fastlaneConfiguration,currentDetectedBrand:Oe,onChange:l.onChange,onSubmitAnalytics:l.onSubmitAnalytics,type:l.type}),De&&l.showPayButton&&l.payButton({status:Y,variant:l.isPayButtonPrimaryVariant?"primary":"secondary",icon:z({imageFolder:"components/"})(`${P}lock`)}))};U.defaultProps=l;export{U as default};
//# sourceMappingURL=CardInput.js.map
