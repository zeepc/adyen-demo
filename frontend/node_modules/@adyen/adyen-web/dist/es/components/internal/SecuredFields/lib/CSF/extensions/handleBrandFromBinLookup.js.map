{"version":3,"file":"handleBrandFromBinLookup.js","sources":["../../../../../../../../src/components/internal/SecuredFields/lib/CSF/extensions/handleBrandFromBinLookup.ts"],"sourcesContent":["import {\n    ENCRYPTED_SECURITY_CODE,\n    ENCRYPTED_CARD_NUMBER,\n    DATE_POLICY_REQUIRED,\n    DATE_POLICY_HIDDEN,\n    ENCRYPTED_EXPIRY_DATE,\n    ENCRYPTED_EXPIRY_MONTH,\n    ENCRYPTED_EXPIRY_YEAR\n} from '../../constants';\nimport postMessageToIframe from '../utils/iframes/postMessageToIframe';\nimport { SFFeedbackObj, SendBrandObject, SendExpiryDateObject } from '../../types';\nimport { BinLookupResponse, BrandObject } from '../../../../../Card/types';\nimport { hasOwnProperty } from '../../../../../../utils/hasOwnProperty';\nimport getIframeContentWin from '../utils/iframes/getIframeContentWin';\nimport { SingleBrandResetObject } from '../../../SFP/types';\n\nexport function sendBrandToCardSF(brandObj: SendBrandObject): void {\n    if (hasOwnProperty(this.state.securedFields, ENCRYPTED_CARD_NUMBER)) {\n        const dataObj: object = {\n            txVariant: this.state.type,\n            ...brandObj,\n            fieldType: ENCRYPTED_CARD_NUMBER,\n            numKey: this.state.securedFields[ENCRYPTED_CARD_NUMBER].numKey\n        };\n        postMessageToIframe(dataObj, getIframeContentWin(this.state, ENCRYPTED_CARD_NUMBER), this.config.loadingContext);\n    }\n}\n\nexport function sendExpiryDatePolicyToSF(expiryDateObj: SendExpiryDateObject): void {\n    const separateDateFields =\n        hasOwnProperty(this.state.securedFields, ENCRYPTED_EXPIRY_MONTH) && hasOwnProperty(this.state.securedFields, ENCRYPTED_EXPIRY_YEAR);\n\n    const dateIframesArr = separateDateFields ? [ENCRYPTED_EXPIRY_MONTH, ENCRYPTED_EXPIRY_YEAR] : [ENCRYPTED_EXPIRY_DATE];\n\n    dateIframesArr.forEach((key: string) => {\n        const dataObj: object = {\n            txVariant: this.state.type,\n            ...expiryDateObj,\n            fieldType: key,\n            numKey: this.state.securedFields[key].numKey\n        };\n        postMessageToIframe(dataObj, getIframeContentWin(this.state, key), this.config.loadingContext);\n    });\n}\n\nexport default function handleBrandFromBinLookup(binLookupResponse: BinLookupResponse, resetObj: SingleBrandResetObject): void {\n    const isGenericCard: boolean = this.state.type === 'card';\n\n    /**\n     * The number of digits in number field has dropped below threshold for BIN lookup (or the bin wasn't found in the DB)\n     * - so tell SF to reset & republish the brand it detects\n     */\n    if (!binLookupResponse || !Object.keys(binLookupResponse).length) {\n        if (isGenericCard) {\n            // This will be sent to CardNumber SF which will trigger the brand to be re-evaluated and broadcast\n            // (which will reset cvcPolicy & expiryDatePolicy in state, here in Checkout)\n            this.sendBrandToCardSF({ brand: 'reset' });\n            // Also pass the reset expiryDatePolicy to the date related SFs so they can reset visibility & aria-required attrs\n            this.sendExpiryDatePolicyToSF({ expiryDatePolicy: DATE_POLICY_REQUIRED });\n        } else {\n            /**\n             * For \"dedicated\" card components, i.e a card component created as: checkout.create('bcmc') but which can accept multiple brands,\n             * there will be no to-and-fro with the securedField iframe to reset brand.\n             * The presence of a resetObj indicates we are in this \"dedicated\"\" scenario, so we need to use the information contained within this object\n             * to internally reset the brand\n             */\n            if (resetObj) {\n                this.processBrand({ ...resetObj, fieldType: ENCRYPTED_CARD_NUMBER } as SFFeedbackObj);\n            }\n        }\n\n        // Reset expiryDatePolicy - which never comes from SF // TODO find out under which circumstances this clause is still required\n        if (this.state.type === 'card' && hasOwnProperty(this.state.securedFields, ENCRYPTED_EXPIRY_DATE)) {\n            this.state.securedFields[ENCRYPTED_EXPIRY_DATE].expiryDatePolicy = DATE_POLICY_REQUIRED;\n        }\n\n        return;\n    }\n\n    const binBrandObj: BrandObject = binLookupResponse.supportedBrands[0];\n\n    const passedBrand: string = binBrandObj.brand;\n\n    // Look first for expiryDatePolicy string otherwise use showExpiryDate boolean\n    const expiryDatePolicy = binBrandObj.expiryDatePolicy ?? (binBrandObj.showExpiryDate === true ? DATE_POLICY_REQUIRED : DATE_POLICY_HIDDEN);\n\n    const brandObj: object = {\n        brand: passedBrand,\n        cvcPolicy: binBrandObj.cvcPolicy,\n        expiryDatePolicy,\n        cvcText: 'Security code',\n        showSocialSecurityNumber: binBrandObj.showSocialSecurityNumber ?? false,\n        fieldType: ENCRYPTED_CARD_NUMBER\n    };\n\n    // Take advantage of function used to handle brand messages from SF in order to process this new brand information\n    this.processBrand(brandObj as SFFeedbackObj);\n\n    if (isGenericCard) {\n        // Pass brand to CardNumber SF\n        const cardObj: SendBrandObject = {\n            brand: passedBrand,\n            enableLuhnCheck: binLookupResponse.supportedBrands[0].enableLuhnCheck !== false,\n            // Only pass the panLength if a) we have one & b) we're not in a switching-between-dual-brands scenario\n            // (because it causes unnecessary callbacks from SF which uses panLength to trigger moving focus to the expiryDate field)\n            ...(binBrandObj?.panLength && !binLookupResponse.isDualBrandSelection && { panLength: binBrandObj?.panLength })\n        };\n        this.sendBrandToCardSF(cardObj);\n\n        // Inform the date related securedFields\n        // - if expiryDatePolicy is 'optional' or 'hidden' they need to set the aria-required attribute / hide themselves\n        this.sendExpiryDatePolicyToSF({ expiryDatePolicy });\n    }\n\n    /**\n     * CHECK IF BRAND CHANGE MEANS FORM IS NOW VALID e.g maestro/bcmc (which don't require cvc) OR bcmc/visa (one of which doesn't require cvc, one of which does)\n     */\n\n    /**\n     * First set the cvcPolicy value on the relevant SecuredFields instance (which will reflect in the cvc field being considered valid,\n     *  as long as it is not in error)...\n     */\n    if (hasOwnProperty(this.state.securedFields, ENCRYPTED_SECURITY_CODE)) {\n        this.state.securedFields[ENCRYPTED_SECURITY_CODE].cvcPolicy = binBrandObj.cvcPolicy;\n    }\n\n    /**\n     * ...then set the expiryDatePolicy...\n     */\n    if (hasOwnProperty(this.state.securedFields, ENCRYPTED_EXPIRY_DATE)) {\n        this.state.securedFields[ENCRYPTED_EXPIRY_DATE].expiryDatePolicy = expiryDatePolicy;\n    } else if (hasOwnProperty(this.state.securedFields, ENCRYPTED_EXPIRY_MONTH) && hasOwnProperty(this.state.securedFields, ENCRYPTED_EXPIRY_YEAR)) {\n        this.state.securedFields[ENCRYPTED_EXPIRY_MONTH].expiryDatePolicy = expiryDatePolicy;\n        this.state.securedFields[ENCRYPTED_EXPIRY_YEAR].expiryDatePolicy = expiryDatePolicy;\n    }\n\n    /**\n     * ...and now re-check if form i.e all the SecuredFields, are valid\n     */\n    this.validateForm();\n}\n"],"names":["sendBrandToCardSF","brandObj","hasOwnProperty","this","state","securedFields","ENCRYPTED_CARD_NUMBER","dataObj","txVariant","type","fieldType","numKey","postMessageToIframe","getIframeContentWin","config","loadingContext","sendExpiryDatePolicyToSF","expiryDateObj","ENCRYPTED_EXPIRY_MONTH","ENCRYPTED_EXPIRY_YEAR","ENCRYPTED_EXPIRY_DATE","forEach","key","handleBrandFromBinLookup","binLookupResponse","resetObj","isGenericCard","Object","keys","length","brand","expiryDatePolicy","DATE_POLICY_REQUIRED","processBrand","binBrandObj","supportedBrands","passedBrand","showExpiryDate","DATE_POLICY_HIDDEN","cvcPolicy","cvcText","showSocialSecurityNumber","cardObj","enableLuhnCheck","panLength","isDualBrandSelection","ENCRYPTED_SECURITY_CODE","validateForm"],"mappings":"qZAgBO,SAASA,EAAkBC,GAC9B,GAAIC,EAAeC,KAAKC,MAAMC,cAAeC,GAAwB,CACjE,MAAMC,EAAkB,CACpBC,UAAWL,KAAKC,MAAMK,QACnBR,EACHS,UAAWJ,EACXK,OAAQR,KAAKC,MAAMC,cAAcC,GAAuBK,QAE5DC,EAAoBL,EAASM,EAAoBV,KAAKC,MAAOE,GAAwBH,KAAKW,OAAOC,eACrG,CACJ,CAEO,SAASC,EAAyBC,IAEjCf,EAAeC,KAAKC,MAAMC,cAAea,IAA2BhB,EAAeC,KAAKC,MAAMC,cAAec,GAErE,CAACD,EAAwBC,GAAyB,CAACC,IAEhFC,QAASC,IACpB,MAAMf,EAAkB,CACpBC,UAAWL,KAAKC,MAAMK,QACnBQ,EACHP,UAAWY,EACXX,OAAQR,KAAKC,MAAMC,cAAciB,GAAKX,QAE1CC,EAAoBL,EAASM,EAAoBV,KAAKC,MAAOkB,GAAMnB,KAAKW,OAAOC,iBAEvF,CAEe,SAASQ,EAAyBC,EAAsCC,GACnF,MAAMC,EAA6C,SAApBvB,KAAKC,MAAMK,KAM1C,IAAKe,IAAsBG,OAAOC,KAAKJ,GAAmBK,OAwBtD,OAvBIH,GAGAvB,KAAKH,kBAAkB,CAAE8B,MAAO,UAEhC3B,KAAKa,yBAAyB,CAAEe,iBAAkBC,KAQ9CP,GACAtB,KAAK8B,aAAa,IAAKR,EAAUf,UAAWJ,SAK5B,SAApBH,KAAKC,MAAMK,MAAmBP,EAAeC,KAAKC,MAAMC,cAAee,KACvEjB,KAAKC,MAAMC,cAAce,GAAuBW,iBAAmBC,IAM3E,MAAME,EAA2BV,EAAkBW,gBAAgB,GAE7DC,EAAsBF,EAAYJ,MAGlCC,EAAmBG,EAAYH,oBAAoD,IAA/BG,EAAYG,eAA0BL,EAAuBM,GAEjHrC,EAAmB,CACrB6B,MAAOM,EACPG,UAAWL,EAAYK,UACvBR,mBACAS,QAAS,gBACTC,yBAA0BP,EAAYO,2BAA4B,EAClE/B,UAAWJ,GAMf,GAFAH,KAAK8B,aAAahC,GAEdyB,EAAe,CAEf,MAAMgB,EAA2B,CAC7BZ,MAAOM,EACPO,iBAA0E,IAAzDnB,EAAkBW,gBAAgB,GAAGQ,mBAGlDT,GAAaU,YAAcpB,EAAkBqB,sBAAwB,CAAED,UAAWV,GAAaU,YAEvGzC,KAAKH,kBAAkB0C,GAIvBvC,KAAKa,yBAAyB,CAAEe,oBACpC,CAUI7B,EAAeC,KAAKC,MAAMC,cAAeyC,KACzC3C,KAAKC,MAAMC,cAAcyC,GAAyBP,UAAYL,EAAYK,WAM1ErC,EAAeC,KAAKC,MAAMC,cAAee,GACzCjB,KAAKC,MAAMC,cAAce,GAAuBW,iBAAmBA,EAC5D7B,EAAeC,KAAKC,MAAMC,cAAea,IAA2BhB,EAAeC,KAAKC,MAAMC,cAAec,KACpHhB,KAAKC,MAAMC,cAAca,GAAwBa,iBAAmBA,EACpE5B,KAAKC,MAAMC,cAAcc,GAAuBY,iBAAmBA,GAMvE5B,KAAK4C,cACT"}