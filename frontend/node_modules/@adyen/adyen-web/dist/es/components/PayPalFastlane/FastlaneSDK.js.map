{"version":3,"file":"FastlaneSDK.js","sources":["../../../../src/components/PayPalFastlane/FastlaneSDK.ts"],"sourcesContent":["import { resolveEnvironments } from '../../core/Environment';\nimport type { FastlaneTokenData } from './services/request-fastlane-token';\nimport requestFastlaneToken from './services/request-fastlane-token';\nimport { convertAdyenLocaleToFastlaneLocale } from './utils/convert-locale';\nimport Script from '../../utils/Script';\nimport AdyenCheckoutError from '../../core/Errors/AdyenCheckoutError';\nimport {\n    FastlaneAuthenticatedCustomerResult,\n    FastlaneConsentRenderState,\n    FastlanePaymentMethodConfiguration,\n    FastlaneSDKConfiguration,\n    FastlaneShippingAddressSelectorResult,\n    FastlaneSignupConfiguration,\n    FastlaneWindowInstance\n} from './types';\n\nimport Analytics from '../../core/Analytics';\nimport { AnalyticsInfoEvent, InfoEventType } from '../../core/Analytics/events/AnalyticsInfoEvent';\nimport type { IAnalytics } from '../../core/Analytics/Analytics';\nimport { AnalyticsEventQueue } from '../../core/Analytics/AnalyticsEventQueue';\nimport { AnalyticsService } from '../../core/Analytics/AnalyticsService';\n\nclass FastlaneSDK {\n    private readonly clientKey: string;\n    private readonly checkoutShopperURL: string;\n    private readonly fastlaneLocale: string;\n    private readonly forceConsentDetails: boolean;\n\n    private readonly analytics: IAnalytics;\n\n    private fastlaneSdk?: FastlaneWindowInstance;\n    private latestShopperDetails?: { email: string; customerId: string };\n    private fastlaneSessionId?: string;\n\n    constructor(configuration: FastlaneSDKConfiguration) {\n        if (!configuration?.environment) throw new AdyenCheckoutError('IMPLEMENTATION_ERROR', \"FastlaneSDK: 'environment' property is required\");\n        if (!configuration?.clientKey) throw new AdyenCheckoutError('IMPLEMENTATION_ERROR', \"FastlaneSDK: 'clientKey' property is required\");\n\n        if (configuration.forceConsentDetails && configuration.environment.includes('live'))\n            console.warn(\"Fastlane SDK: 'forceConsentDetails' should not be used on 'live' environment\");\n\n        const { apiUrl, analyticsUrl } = resolveEnvironments(configuration.environment);\n\n        this.checkoutShopperURL = apiUrl;\n        this.clientKey = configuration.clientKey;\n        this.forceConsentDetails = configuration.forceConsentDetails || false;\n        this.fastlaneLocale = convertAdyenLocaleToFastlaneLocale(configuration.locale || 'en-US');\n\n        this.analytics = new Analytics({\n            eventQueue: new AnalyticsEventQueue(),\n            service: new AnalyticsService({\n                analyticsContext: analyticsUrl,\n                clientKey: this.clientKey\n            }),\n            enabled: configuration.analytics?.enabled\n        });\n\n        document.addEventListener('visibilitychange', this.handlePageVisibilityChanges);\n    }\n\n    /**\n     * Initializes the Fastlane SDK\n     */\n    public async initialize(): Promise<FastlaneSDK> {\n        void this.analytics.setUp({\n            checkoutStage: 'precheckout'\n        });\n\n        const tokenData = await this.requestClientToken();\n        await this.fetchSdk(tokenData.value, tokenData.clientId);\n        await this.initializeFastlaneInstance();\n        this.trackEvent(InfoEventType.Initialized);\n        return this;\n    }\n\n    public destroy(): void {\n        document.removeEventListener('visibilitychange', this.handlePageVisibilityChanges);\n        this.analytics.flush();\n    }\n\n    /**\n     * Triggers the authentication for Fastlane using shopper's email.\n     * If shopper is recognized, the OTP flow is initialized.\n     *\n     * @param email\n     */\n    public async authenticate(email: string): Promise<FastlaneAuthenticatedCustomerResult> {\n        if (!this.fastlaneSdk) {\n            throw new AdyenCheckoutError('IMPLEMENTATION_ERROR', 'authenticate(): Fastlane SDK is not initialized');\n        }\n\n        this.trackEvent(InfoEventType.LookupStarted);\n\n        try {\n            const { customerContextId } = await this.fastlaneSdk.identity.lookupCustomerByEmail(email);\n\n            if (customerContextId) {\n                this.latestShopperDetails = { email, customerId: customerContextId };\n                this.trackEvent(InfoEventType.OtpStarted);\n\n                const authResult = await this.fastlaneSdk.identity.triggerAuthenticationFlow(customerContextId);\n                this.trackEvent(this.getOtpAnalyticsSubtype(authResult.authenticationState));\n\n                return authResult;\n            }\n\n            this.trackEvent(InfoEventType.LookupUserNotFound);\n            return {\n                authenticationState: 'not_found',\n                profileData: undefined\n            };\n        } catch (error: unknown) {\n            throw new AdyenCheckoutError('ERROR', 'Fastlane SDK: An error occurred during the authentication flow.', { cause: error });\n        }\n    }\n\n    /**\n     * Creates the Component configuration based on the Fastlane authentication result.\n     *\n     * In case the shopper authenticated successfully, it returns config to be used in the Fastlane component\n     * Otherwise, it returns the configuration to be used in the Card component\n     *\n     * @param authResult\n     */\n    public async getComponentConfiguration(authResult: FastlaneAuthenticatedCustomerResult): Promise<FastlanePaymentMethodConfiguration> {\n        if (!authResult) {\n            throw new AdyenCheckoutError(\n                'IMPLEMENTATION_ERROR',\n                'FastlaneSDK: you must pass the authentication result to get the component configuration'\n            );\n        }\n\n        this.analytics.flush();\n\n        const isAuthSuccess = authResult.authenticationState === 'succeeded';\n        const hasCardData = !!authResult.profileData?.card;\n        const hasShopperDetails = !!this.latestShopperDetails?.email;\n\n        if (isAuthSuccess && hasCardData && hasShopperDetails) {\n            return this.createFastlaneComponentConfiguration(authResult);\n        }\n\n        return this.createCardComponentConfiguration();\n    }\n\n    /**\n     * Displays the Fastlane Shipping Address selector UI\n     */\n    public async showShippingAddressSelector(): Promise<FastlaneShippingAddressSelectorResult> {\n        if (!this.fastlaneSdk) {\n            throw new AdyenCheckoutError('IMPLEMENTATION_ERROR', 'showShippingAddressSelector(): Fastlane SDK is not initialized');\n        }\n\n        this.trackEvent(InfoEventType.AddressSelectorClicked);\n\n        try {\n            const addressSelectorResult = await this.fastlaneSdk.profile.showShippingAddressSelector();\n            if (addressSelectorResult.selectionChanged) {\n                this.trackEvent(InfoEventType.AddressChanged);\n            }\n            this.trackEvent(InfoEventType.AddressSelectorClosed);\n\n            return addressSelectorResult;\n        } catch (error: unknown) {\n            throw new AdyenCheckoutError('ERROR', 'Fastlane SDK: An error occurred when showing the shipping address selector', { cause: error });\n        }\n    }\n\n    /**\n     * Render the \"Fastlane by PayPal\" logo in the specified HTML container\n     */\n    public async mountWatermark(container: HTMLElement | string, options = { includeAdditionalInfo: true }): Promise<void> {\n        if (!this.fastlaneSdk) {\n            throw new AdyenCheckoutError('IMPLEMENTATION_ERROR', 'mountWatermark(): Fastlane SDK is not initialized');\n        }\n\n        try {\n            const component = await this.fastlaneSdk.FastlaneWatermarkComponent(options);\n            component.render(container);\n        } catch (error: unknown) {\n            throw new AdyenCheckoutError('ERROR', 'Fastlane SDK: An error occurred when rendering the watermark', { cause: error });\n        }\n    }\n\n    private requestClientToken(): Promise<FastlaneTokenData> {\n        return requestFastlaneToken(this.checkoutShopperURL, this.clientKey);\n    }\n\n    private async fetchSdk(clientToken: string, clientId: string): Promise<void> {\n        const sdkUrl = new URL('https://www.paypal.com/sdk/js');\n        sdkUrl.searchParams.set('client-id', clientId);\n        sdkUrl.searchParams.set('components', 'buttons,fastlane');\n\n        const script = new Script({\n            src: sdkUrl.href,\n            component: 'fastlane',\n            dataAttributes: { sdkClientToken: clientToken },\n            analytics: this.analytics\n        });\n\n        await script.load();\n    }\n\n    /**\n     * Fetch the fastlane session ID used internally by PayPal for Network Token Usage event\n     * This ID is not critical for the payment processing part\n     *\n     * @private\n     */\n    private async fetchSessionIdAsync(): Promise<void> {\n        try {\n            const { sessionId } = await this.fastlaneSdk.identity.getSession();\n            this.fastlaneSessionId = sessionId;\n        } catch (error) {\n            console.warn('Fastlane SDK: Failed to fetch session ID', error);\n        }\n    }\n\n    /**\n     * Fetch object containing that details that will be used to display the sign-up UI\n     * inside the card component\n     * @private\n     */\n    private async fetchConsentDetails(): Promise<FastlaneConsentRenderState> {\n        try {\n            const consentComponent = await this.fastlaneSdk.ConsentComponent();\n            return await consentComponent.getRenderState();\n        } catch (error) {\n            throw new AdyenCheckoutError('ERROR', 'fetchConsentDetails(): failed to fetch consent details', { cause: error });\n        }\n    }\n\n    private async initializeFastlaneInstance(): Promise<void> {\n        try {\n            this.fastlaneSdk = await window.paypal.Fastlane({\n                intendedExperience: 'externalProcessorCustomConsent',\n                ...(this.forceConsentDetails && {\n                    metadata: {\n                        geoLocOverride: 'US'\n                    }\n                })\n            });\n            this.fastlaneSdk.setLocale(this.fastlaneLocale);\n\n            void this.fetchSessionIdAsync();\n        } catch (error) {\n            throw new AdyenCheckoutError('ERROR', 'Fastlane SDK: Failed to initialize fastlane using the window.paypal.Fastlane constructor', {\n                cause: error\n            });\n        }\n    }\n\n    /**\n     * Creates the configuration for the Fastlane component\n     *\n     * @param authResult\n     * @private\n     */\n    private createFastlaneComponentConfiguration(authResult: FastlaneAuthenticatedCustomerResult): FastlanePaymentMethodConfiguration {\n        return {\n            paymentType: 'fastlane',\n            configuration: {\n                fastlaneSessionId: this.fastlaneSessionId,\n                email: this.latestShopperDetails.email,\n                tokenId: authResult.profileData.card.id,\n                lastFour: authResult.profileData.card.paymentSource.card.lastDigits,\n                brand: authResult.profileData.card.paymentSource.card.brand.toLowerCase()\n            }\n        };\n    }\n\n    /**\n     * Creates the configuration for the Card component, including Fastlane sign-up details if available\n     *\n     * @private\n     */\n    private async createCardComponentConfiguration(): Promise<FastlanePaymentMethodConfiguration> {\n        const consentDetails = await this.fetchConsentDetails();\n        const configuration: { fastlaneConfiguration?: FastlaneSignupConfiguration } = {};\n\n        if (consentDetails) {\n            configuration.fastlaneConfiguration = {\n                fastlaneSessionId: this.fastlaneSessionId,\n                ...consentDetails\n            };\n        }\n\n        return {\n            paymentType: 'card',\n            configuration\n        };\n    }\n\n    private trackEvent(eventType: InfoEventType): void {\n        const event = new AnalyticsInfoEvent({ type: eventType, component: 'fastlane' });\n        this.analytics.sendAnalytics(event);\n    }\n\n    private handlePageVisibilityChanges = (): void => {\n        if (document.visibilityState === 'hidden') {\n            this.analytics.flush();\n        }\n    };\n\n    /**\n     * Returns the Info event subtype based on the 'authenticationState'\n     * @param authenticationState\n     * @private\n     */\n    private getOtpAnalyticsSubtype(authenticationState: FastlaneAuthenticatedCustomerResult['authenticationState']) {\n        switch (authenticationState) {\n            case 'succeeded':\n                return InfoEventType.OtpSucceeded;\n            case 'canceled':\n                return InfoEventType.OtpCanceled;\n            case 'failed':\n                return InfoEventType.OtpFailed;\n            case 'not_found':\n                return InfoEventType.LookupUserNotFound;\n            default:\n                return InfoEventType.OtpFailed;\n        }\n    }\n}\n\nexport default FastlaneSDK;\n"],"names":["FastlaneSDK","initialize","this","analytics","setUp","checkoutStage","tokenData","requestClientToken","fetchSdk","value","clientId","initializeFastlaneInstance","trackEvent","InfoEventType","Initialized","destroy","document","removeEventListener","handlePageVisibilityChanges","flush","authenticate","email","fastlaneSdk","AdyenCheckoutError","LookupStarted","customerContextId","identity","lookupCustomerByEmail","latestShopperDetails","customerId","OtpStarted","authResult","triggerAuthenticationFlow","getOtpAnalyticsSubtype","authenticationState","LookupUserNotFound","profileData","undefined","error","cause","getComponentConfiguration","isAuthSuccess","hasCardData","card","hasShopperDetails","createFastlaneComponentConfiguration","createCardComponentConfiguration","showShippingAddressSelector","AddressSelectorClicked","addressSelectorResult","profile","selectionChanged","AddressChanged","AddressSelectorClosed","mountWatermark","container","options","includeAdditionalInfo","FastlaneWatermarkComponent","render","requestFastlaneToken","checkoutShopperURL","clientKey","clientToken","sdkUrl","URL","searchParams","set","script","Script","src","href","component","dataAttributes","sdkClientToken","load","fetchSessionIdAsync","sessionId","getSession","fastlaneSessionId","console","warn","fetchConsentDetails","consentComponent","ConsentComponent","getRenderState","window","paypal","Fastlane","intendedExperience","forceConsentDetails","metadata","geoLocOverride","setLocale","fastlaneLocale","paymentType","configuration","tokenId","id","lastFour","paymentSource","lastDigits","brand","toLowerCase","consentDetails","fastlaneConfiguration","eventType","event","AnalyticsInfoEvent","type","sendAnalytics","OtpSucceeded","OtpCanceled","OtpFailed","constructor","_define_property","visibilityState","environment","includes","apiUrl","analyticsUrl","resolveEnvironments","convertAdyenLocaleToFastlaneLocale","locale","Analytics","eventQueue","AnalyticsEventQueue","service","AnalyticsService","analyticsContext","enabled","addEventListener"],"mappings":"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"}