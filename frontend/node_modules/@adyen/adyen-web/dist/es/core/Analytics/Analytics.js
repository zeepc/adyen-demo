import{debounce as e}from"../../utils/debounce.js";import{processAnalyticsData as t}from"./utils.js";import{AnalyticsEventCategory as s}from"./events/AbstractAnalyticsEvent.js";import n from"../../utils/Storage.js";import{LIBRARY_BUNDLE_TYPE as i,LIBRARY_VERSION as o}from"../config.js";function a(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class r{get checkoutAttemptId(){return this.capturedCheckoutAttemptId}async setUp({sessionId:e,checkoutStage:s,locale:n}={}){try{const a=this.storage.get(),r=function(e){if(!e?.timestamp)return!1;const t=Date.now()-9e5;return e.timestamp>t}(a),{applicationInfo:c,checkoutAttemptId:d}=t(this.analyticsData),h=r?a.id:d,u={version:o,buildType:i,channel:"Web",platform:"Web",locale:n,referrer:window.location.href,screenWidth:window.screen.width,checkoutStage:s||"checkout",level:this.enabled?"all":"initial",...c&&{applicationInfo:c},...e&&{sessionId:e},...h&&{checkoutAttemptId:h}};this.capturedCheckoutAttemptId=await this.service.requestCheckoutAttemptId(u),this.storage.set({id:this.capturedCheckoutAttemptId,timestamp:r?a.timestamp:Date.now()})}catch(e){this.enabled=!1,console.warn("Analytics: Error setting up",e)}}sendAnalytics(e){if(this.enabled)try{this.addEventToQueue(e)}catch(e){console.warn("Analytics: Error adding event to queue",e)}}async sendFlavor(e){if(this.capturedCheckoutAttemptId&&!this.isFlavorReported){this.isFlavorReported=!0;try{await this.service.reportIntegrationFlavor(e,this.capturedCheckoutAttemptId)}catch(e){console.warn("Analytics: Error reporting flavor",e)}}}flush(){this.sendEvents()}addEventToQueue(e){this.eventsQueue.add(e),e.getEventCategory()===s.info?this.debouncedSendInfoEvents():this.debouncedSendEvents()}async sendEvents(){if(!this.capturedCheckoutAttemptId||!this.enabled)return;const e={channel:"Web",platform:"Web",info:this.eventsQueue.infoEvents,errors:this.eventsQueue.errorEvents,logs:this.eventsQueue.logEvents};this.eventsQueue.clear();try{await this.service.sendEvents(e,this.capturedCheckoutAttemptId)}catch(e){console.warn("Analytics: Error sending events",e)}}constructor({service:t,eventQueue:s,enabled:i,analyticsData:o}){a(this,"analyticsData",void 0),a(this,"service",void 0),a(this,"eventsQueue",void 0),a(this,"storage",new n("checkout-attempt-id","sessionStorage")),a(this,"debouncedSendInfoEvents",void 0),a(this,"debouncedSendEvents",void 0),a(this,"enabled",!0),a(this,"capturedCheckoutAttemptId",void 0),a(this,"isFlavorReported",!1),this.service=t,this.eventsQueue=s,this.debouncedSendInfoEvents=e(this.sendEvents.bind(this),1e4),this.debouncedSendEvents=e(this.sendEvents.bind(this),5e3),void 0!==i&&(this.enabled=i),o&&(this.analyticsData=o)}}export{r as default};
//# sourceMappingURL=Analytics.js.map
