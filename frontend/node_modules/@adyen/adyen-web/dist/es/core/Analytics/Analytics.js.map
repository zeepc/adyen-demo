{"version":3,"file":"Analytics.js","sources":["../../../../src/core/Analytics/Analytics.ts"],"sourcesContent":["import { debounce } from '../../utils/debounce';\nimport { processAnalyticsData } from './utils';\nimport { AbstractAnalyticsEvent, AnalyticsEventCategory } from './events/AbstractAnalyticsEvent';\nimport Storage from '../../utils/Storage';\nimport { LIBRARY_BUNDLE_TYPE, LIBRARY_VERSION } from '../config';\nimport { AnalyticsEventQueue } from './AnalyticsEventQueue';\nimport type { AnalyticsOptions } from './types';\nimport type { AnalyticsEventPayload, IAnalyticsService, RequestAttemptIdPayload } from './AnalyticsService';\n\nexport interface AnalyticsProps {\n    service: IAnalyticsService;\n    eventQueue: AnalyticsEventQueue;\n    enabled?: boolean;\n    analyticsData?: AnalyticsOptions['analyticsData'];\n}\n\nexport interface IAnalytics {\n    checkoutAttemptId?: string;\n    setUp({ sessionId, checkoutStage, locale }: { sessionId?: string; checkoutStage?: 'precheckout' | 'checkout'; locale?: string }): Promise<void>;\n    sendFlavor(flavor: 'dropin' | 'components'): Promise<void>;\n    sendAnalytics(event: AbstractAnalyticsEvent): void;\n    flush(): void;\n}\n\nexport interface CheckoutAttemptIdSessionStorage {\n    id: string;\n    timestamp: number;\n}\n\n/**\n * If the checkout attempt ID was stored more than fifteen minutes ago, then we should request a new ID.\n * More here: COWEB-1099\n */\nfunction isSessionCreatedUnderFifteenMinutes(session: CheckoutAttemptIdSessionStorage | null): boolean {\n    const FIFTEEN_MINUTES_IN_MS = 15 * 60 * 1000;\n    if (!session?.timestamp) return false;\n    const fifteenMinutesAgo = Date.now() - FIFTEEN_MINUTES_IN_MS;\n    return session.timestamp > fifteenMinutesAgo;\n}\n\nconst ANALYTICS_INFO_DEBOUNCE_DELAY = process.env.NODE_ENV === 'development' ? 5_000 : 10_000;\nconst ANALYTICS_ERROR_AND_LOGS_DEBOUNCE_DELAY = 5_000;\n\nclass Analytics implements IAnalytics {\n    private readonly analyticsData?: AnalyticsOptions['analyticsData'];\n    private readonly service: IAnalyticsService;\n    private readonly eventsQueue: AnalyticsEventQueue;\n    private readonly storage = new Storage<CheckoutAttemptIdSessionStorage>('checkout-attempt-id', 'sessionStorage');\n    private readonly debouncedSendInfoEvents: () => void;\n    private readonly debouncedSendEvents: () => void;\n\n    private enabled: boolean = true;\n    private capturedCheckoutAttemptId?: string;\n    private isFlavorReported = false;\n\n    constructor({ service, eventQueue, enabled, analyticsData }: AnalyticsProps) {\n        this.service = service;\n        this.eventsQueue = eventQueue;\n\n        this.debouncedSendInfoEvents = debounce(this.sendEvents.bind(this), ANALYTICS_INFO_DEBOUNCE_DELAY);\n        this.debouncedSendEvents = debounce(this.sendEvents.bind(this), ANALYTICS_ERROR_AND_LOGS_DEBOUNCE_DELAY);\n\n        if (enabled !== undefined) this.enabled = enabled;\n        if (analyticsData) this.analyticsData = analyticsData;\n    }\n\n    public get checkoutAttemptId(): string {\n        return this.capturedCheckoutAttemptId;\n    }\n\n    public async setUp({\n        sessionId,\n        checkoutStage,\n        locale\n    }: { sessionId?: string; locale?: string; checkoutStage?: 'precheckout' | 'checkout' } = {}): Promise<void> {\n        try {\n            const checkoutAttemptIdSession = this.storage.get();\n            const isSessionReusable = isSessionCreatedUnderFifteenMinutes(checkoutAttemptIdSession);\n\n            const { applicationInfo, checkoutAttemptId: checkoutAttemptIdFromPayByLink } = processAnalyticsData(this.analyticsData);\n\n            const availableCheckoutAttemptId: string | undefined = isSessionReusable ? checkoutAttemptIdSession.id : checkoutAttemptIdFromPayByLink;\n\n            const payload: RequestAttemptIdPayload = {\n                version: LIBRARY_VERSION,\n                buildType: LIBRARY_BUNDLE_TYPE,\n                channel: 'Web',\n                platform: 'Web',\n                locale,\n                referrer: window.location.href,\n                screenWidth: window.screen.width,\n                checkoutStage: checkoutStage || 'checkout',\n                level: this.enabled ? 'all' : 'initial',\n                ...(applicationInfo && { applicationInfo }),\n                ...(sessionId && { sessionId }),\n                ...(availableCheckoutAttemptId && { checkoutAttemptId: availableCheckoutAttemptId })\n            };\n\n            this.capturedCheckoutAttemptId = await this.service.requestCheckoutAttemptId(payload);\n\n            this.storage.set({\n                id: this.capturedCheckoutAttemptId,\n                timestamp: isSessionReusable ? checkoutAttemptIdSession.timestamp : Date.now()\n            });\n        } catch (error: unknown) {\n            this.enabled = false;\n            console.warn('Analytics: Error setting up', error);\n        }\n    }\n\n    public sendAnalytics(event: AbstractAnalyticsEvent): void {\n        if (!this.enabled) {\n            return;\n        }\n\n        try {\n            this.addEventToQueue(event);\n        } catch (error: unknown) {\n            console.warn('Analytics: Error adding event to queue', error);\n        }\n    }\n\n    public async sendFlavor(flavor: 'dropin' | 'components'): Promise<void> {\n        if (!this.capturedCheckoutAttemptId) return;\n        if (this.isFlavorReported) return;\n\n        this.isFlavorReported = true;\n\n        try {\n            await this.service.reportIntegrationFlavor(flavor, this.capturedCheckoutAttemptId);\n        } catch (error) {\n            console.warn('Analytics: Error reporting flavor', error);\n        }\n    }\n\n    public flush(): void {\n        void this.sendEvents();\n    }\n\n    /**\n     * Info events don't have high priority, therefore  we add a delay in order to dispatch a batch of events\n     * Log/Error events are sent almost immediately. There is a debounce mechanism in place but the delay is very minimal\n     *\n     * @param event\n     * @private\n     */\n    private addEventToQueue(event: AbstractAnalyticsEvent): void {\n        this.eventsQueue.add(event);\n\n        if (event.getEventCategory() === AnalyticsEventCategory.info) {\n            this.debouncedSendInfoEvents();\n        } else {\n            this.debouncedSendEvents();\n        }\n    }\n\n    private async sendEvents(): Promise<void> {\n        if (!this.capturedCheckoutAttemptId || !this.enabled) {\n            return;\n        }\n\n        const payload: AnalyticsEventPayload = {\n            channel: 'Web',\n            platform: 'Web',\n            info: this.eventsQueue.infoEvents,\n            errors: this.eventsQueue.errorEvents,\n            logs: this.eventsQueue.logEvents\n        };\n\n        this.eventsQueue.clear();\n\n        try {\n            await this.service.sendEvents(payload, this.capturedCheckoutAttemptId);\n        } catch (error) {\n            console.warn('Analytics: Error sending events', error);\n        }\n    }\n}\n\nexport default Analytics;\n"],"names":["Analytics","checkoutAttemptId","this","capturedCheckoutAttemptId","setUp","sessionId","checkoutStage","locale","checkoutAttemptIdSession","storage","get","isSessionReusable","session","timestamp","fifteenMinutesAgo","Date","now","isSessionCreatedUnderFifteenMinutes","applicationInfo","checkoutAttemptIdFromPayByLink","processAnalyticsData","analyticsData","availableCheckoutAttemptId","id","payload","version","LIBRARY_VERSION","buildType","LIBRARY_BUNDLE_TYPE","channel","platform","referrer","window","location","href","screenWidth","screen","width","level","enabled","service","requestCheckoutAttemptId","set","error","console","warn","sendAnalytics","event","addEventToQueue","sendFlavor","flavor","isFlavorReported","reportIntegrationFlavor","flush","sendEvents","eventsQueue","add","getEventCategory","AnalyticsEventCategory","info","debouncedSendInfoEvents","debouncedSendEvents","infoEvents","errors","errorEvents","logs","logEvents","clear","constructor","eventQueue","_define_property","Storage","debounce","bind","undefined"],"mappings":"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"}