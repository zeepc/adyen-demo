{"version":3,"file":"usePaymentStatusTimer.js","sources":["../../../../src/hooks/usePaymentStatusTimer/usePaymentStatusTimer.tsx"],"sourcesContent":["import { useState, useEffect, useRef } from 'preact/hooks';\nimport checkPaymentStatus from '../../core/Services/payment-status';\nimport { processPaymentStatusResponse } from '../../core/ProcessResponse/PaymentStatus';\nimport AdyenCheckoutError from '../../core/Errors/AdyenCheckoutError';\nimport { CountdownTime } from '../../components/internal/Countdown/types';\nimport { PaymentStatusTimerActions, PaymentStatusTimerState, UsePaymentStatusTimerProps } from './types';\nimport {\n    DEFAULT_PAYMENT_STATUS_TIMER_DELAY_MS,\n    DEFAULT_PAYMENT_STATUS_TIMER_THROTTLE_INTERVAL_MS,\n    DEFAULT_PAYMENT_STATUS_TIMER_THROTTLE_TIME_MS\n} from './constants';\nimport { AdditionalDetailsData, ProcessedPaymentStatusResponse } from '../../types';\n\nexport function usePaymentStatusTimer(props: UsePaymentStatusTimerProps): { state: PaymentStatusTimerState; actions: PaymentStatusTimerActions } {\n    const [completed, setCompleted] = useState(false);\n    const [expired, setExpired] = useState(false);\n    const [loading, setLoading] = useState(true);\n    const [delay, setDelay] = useState(props.delay ?? DEFAULT_PAYMENT_STATUS_TIMER_DELAY_MS);\n    const [percentage, setPercentage] = useState(100);\n    const [timePassed, setTimePassed] = useState(0);\n    const [onPollingStartedActionHandled, setOnPollingStartedActionHandled] = useState(false);\n    const timeoutRef = useRef<NodeJS.Timeout | number | null>(null);\n\n    const onTick = (time: CountdownTime): void => {\n        setPercentage(time.percentage);\n    };\n\n    const onTimeUp = (): void => {\n        setExpired(true);\n        props.onError(new AdyenCheckoutError('ERROR', 'Payment Expired'));\n    };\n\n    const onComplete = (status: ProcessedPaymentStatusResponse): void => {\n        setCompleted(true);\n        setLoading(false);\n\n        if (status.props.payload) {\n            const additionalDetailsData: AdditionalDetailsData = {\n                data: {\n                    details: { payload: status.props.payload },\n                    paymentData: props.paymentData\n                }\n            };\n            props.onComplete(additionalDetailsData);\n        } else {\n            setExpired(true);\n            props.onError(new AdyenCheckoutError('ERROR', 'successful result, but no payload in response'));\n        }\n    };\n\n    const onError = (status: ProcessedPaymentStatusResponse): void => {\n        setExpired(true);\n        setLoading(false);\n\n        if (status.props.payload) {\n            const additionalDetailsData: AdditionalDetailsData = {\n                data: {\n                    details: { payload: status.props.payload },\n                    paymentData: props.paymentData\n                }\n            };\n            props.onComplete(additionalDetailsData);\n        } else {\n            const error = new AdyenCheckoutError('ERROR', 'error result with no payload in response');\n            props.onError(error);\n        }\n    };\n\n    const checkStatus = async (): Promise<void> => {\n        const { paymentData, clientKey, throttleInterval, pollStatus } = props;\n\n        const pollStatusFunction = pollStatus ?? (() => checkPaymentStatus(paymentData, clientKey, props.loadingContext, throttleInterval));\n\n        if (!onPollingStartedActionHandled) {\n            props.onActionHandled?.({ componentType: props.type, actionDescription: 'polling-started' });\n            setOnPollingStartedActionHandled(true);\n        }\n\n        return pollStatusFunction()\n            .then(processPaymentStatusResponse)\n            .catch(\n                (error: unknown) =>\n                    ({\n                        type: 'network-error',\n                        props: error\n                    }) as ProcessedPaymentStatusResponse\n            )\n            .then((status: ProcessedPaymentStatusResponse) => {\n                switch (status.type) {\n                    case 'success':\n                        onComplete(status);\n                        break;\n                    case 'error':\n                        onError(status);\n                        break;\n                    default:\n                        setLoading(false);\n                }\n            });\n    };\n\n    useEffect(() => {\n        void checkStatus();\n    }, []);\n\n    useEffect(() => {\n        if (expired || completed || loading) {\n            return;\n        }\n\n        const statusInterval = async (): Promise<void> => {\n            const start = performance.now();\n            await checkStatus();\n            const end = performance.now();\n            const responseTime = Math.round(end - start);\n\n            const actualTimePassed = timePassed + responseTime + delay;\n            setTimePassed(actualTimePassed);\n\n            if (\n                actualTimePassed >= (props.throttleTime ?? DEFAULT_PAYMENT_STATUS_TIMER_THROTTLE_TIME_MS) &&\n                delay !== (props.throttleInterval ?? DEFAULT_PAYMENT_STATUS_TIMER_THROTTLE_INTERVAL_MS)\n            ) {\n                setDelay(props.throttleInterval ?? DEFAULT_PAYMENT_STATUS_TIMER_THROTTLE_INTERVAL_MS);\n            }\n        };\n\n        timeoutRef.current = setTimeout(() => {\n            void statusInterval();\n        }, delay);\n\n        return () => {\n            clearTimeout(timeoutRef.current);\n        };\n    }, [expired, completed, loading, delay, props.throttleTime, props.throttleInterval, timePassed]);\n\n    const state: PaymentStatusTimerState = {\n        completed,\n        expired,\n        loading,\n        percentage,\n        timePassed\n    };\n\n    const actions: PaymentStatusTimerActions = {\n        onTick,\n        onTimeUp\n    };\n\n    return { state, actions };\n}\n"],"names":["usePaymentStatusTimer","props","completed","setCompleted","useState","expired","setExpired","loading","setLoading","delay","setDelay","DEFAULT_PAYMENT_STATUS_TIMER_DELAY_MS","percentage","setPercentage","timePassed","setTimePassed","onPollingStartedActionHandled","setOnPollingStartedActionHandled","timeoutRef","useRef","checkStatus","async","paymentData","clientKey","throttleInterval","pollStatus","pollStatusFunction","checkPaymentStatus","loadingContext","onActionHandled","componentType","type","actionDescription","then","processPaymentStatusResponse","catch","error","status","payload","additionalDetailsData","data","details","onComplete","onError","AdyenCheckoutError","useEffect","current","setTimeout","start","performance","now","end","responseTime","Math","round","actualTimePassed","throttleTime","DEFAULT_PAYMENT_STATUS_TIMER_THROTTLE_TIME_MS","DEFAULT_PAYMENT_STATUS_TIMER_THROTTLE_INTERVAL_MS","statusInterval","clearTimeout","state","actions","onTick","time","onTimeUp"],"mappings":"seAaO,SAASA,EAAsBC,GAClC,MAAOC,EAAWC,GAAgBC,GAAS,IACpCC,EAASC,GAAcF,GAAS,IAChCG,EAASC,GAAcJ,GAAS,IAChCK,EAAOC,GAAYN,EAASH,EAAMQ,OAASE,IAC3CC,EAAYC,GAAiBT,EAAS,MACtCU,EAAYC,GAAiBX,EAAS,IACtCY,EAA+BC,GAAoCb,GAAS,GAC7Ec,EAAaC,EAAuC,MA+CpDC,EAAcC,UAChB,MAAMC,YAAEA,EAAWC,UAAEA,EAASC,iBAAEA,EAAgBC,WAAEA,GAAexB,EAE3DyB,EAAqBD,GAAAA,KAAqBE,EAAmBL,EAAaC,EAAWtB,EAAM2B,eAAgBJ,IAOjH,OALKR,IACDf,EAAM4B,kBAAkB,CAAEC,cAAe7B,EAAM8B,KAAMC,kBAAmB,oBACxEf,GAAiC,IAG9BS,IACFO,KAAKC,GACLC,MACIC,KAEOL,KAAM,gBACN9B,MAAOmC,KAGlBH,KAAMI,IACH,OAAQA,EAAON,MACX,IAAK,UAzDF,CAACM,IAIhB,GAHAlC,GAAa,GACbK,GAAW,GAEP6B,EAAOpC,MAAMqC,QAAS,CACtB,MAAMC,EAA+C,CACjDC,KAAM,CACFC,QAAS,CAAEH,QAASD,EAAOpC,MAAMqC,SACjChB,YAAarB,EAAMqB,cAG3BrB,EAAMyC,WAAWH,EACrB,MACIjC,GAAW,GACXL,EAAM0C,QAAQ,IAAIC,EAAmB,QAAS,mDA4ClCF,CAAWL,GACX,MACJ,IAAK,QA1CL,CAACA,IAIb,GAHA/B,GAAW,GACXE,GAAW,GAEP6B,EAAOpC,MAAMqC,QAAS,CACtB,MAAMC,EAA+C,CACjDC,KAAM,CACFC,QAAS,CAAEH,QAASD,EAAOpC,MAAMqC,SACjChB,YAAarB,EAAMqB,cAG3BrB,EAAMyC,WAAWH,EACrB,KAAO,CACH,MAAMH,EAAQ,IAAIQ,EAAmB,QAAS,4CAC9C3C,EAAM0C,QAAQP,EAClB,GA4BgBO,CAAQN,GACR,MACJ,QACI7B,GAAW,OAK/BqC,EAAU,KACDzB,KACN,IAEHyB,EAAU,KACN,GAAIxC,GAAWH,GAAaK,EACxB,OAwBJ,OAJAW,EAAW4B,QAAUC,WAAW,KAjBT1B,WACnB,MAAM2B,EAAQC,YAAYC,YACpB9B,IACN,MAAM+B,EAAMF,YAAYC,MAClBE,EAAeC,KAAKC,MAAMH,EAAMH,GAEhCO,EAAmBzC,EAAasC,EAAe3C,EACrDM,EAAcwC,GAGVA,IAAqBtD,EAAMuD,cAAgBC,IAC3ChD,KAAWR,EAAMuB,kBAAoBkC,IAErChD,EAAST,EAAMuB,kBAAoBkC,IAKlCC,IACNlD,GAEI,KACHmD,aAAa1C,EAAW4B,WAE7B,CAACzC,EAASH,EAAWK,EAASE,EAAOR,EAAMuD,aAAcvD,EAAMuB,iBAAkBV,IAepF,MAAO,CAAE+C,MAb8B,CACnC3D,YACAG,UACAE,UACAK,aACAE,cAQYgD,QAL2B,CACvCC,OA1HYC,IACZnD,EAAcmD,EAAKpD,aA0HnBqD,SAvHa,KACb3D,GAAW,GACXL,EAAM0C,QAAQ,IAAIC,EAAmB,QAAS,sBAyHtD"}