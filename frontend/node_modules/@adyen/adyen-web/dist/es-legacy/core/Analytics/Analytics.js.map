{"version":3,"file":"Analytics.js","sources":["../../../../src/core/Analytics/Analytics.ts"],"sourcesContent":["import { debounce } from '../../utils/debounce';\nimport { processAnalyticsData } from './utils';\nimport { AbstractAnalyticsEvent, AnalyticsEventCategory } from './events/AbstractAnalyticsEvent';\nimport Storage from '../../utils/Storage';\nimport { LIBRARY_BUNDLE_TYPE, LIBRARY_VERSION } from '../config';\nimport { AnalyticsEventQueue } from './AnalyticsEventQueue';\nimport type { AnalyticsOptions } from './types';\nimport type { AnalyticsEventPayload, IAnalyticsService, RequestAttemptIdPayload } from './AnalyticsService';\n\nexport interface AnalyticsProps {\n    service: IAnalyticsService;\n    eventQueue: AnalyticsEventQueue;\n    enabled?: boolean;\n    analyticsData?: AnalyticsOptions['analyticsData'];\n}\n\nexport interface IAnalytics {\n    checkoutAttemptId?: string;\n    setUp({ sessionId, checkoutStage, locale }: { sessionId?: string; checkoutStage?: 'precheckout' | 'checkout'; locale?: string }): Promise<void>;\n    sendFlavor(flavor: 'dropin' | 'components'): Promise<void>;\n    sendAnalytics(event: AbstractAnalyticsEvent): void;\n    flush(): void;\n}\n\nexport interface CheckoutAttemptIdSessionStorage {\n    id: string;\n    timestamp: number;\n}\n\n/**\n * If the checkout attempt ID was stored more than fifteen minutes ago, then we should request a new ID.\n * More here: COWEB-1099\n */\nfunction isSessionCreatedUnderFifteenMinutes(session: CheckoutAttemptIdSessionStorage | null): boolean {\n    const FIFTEEN_MINUTES_IN_MS = 15 * 60 * 1000;\n    if (!session?.timestamp) return false;\n    const fifteenMinutesAgo = Date.now() - FIFTEEN_MINUTES_IN_MS;\n    return session.timestamp > fifteenMinutesAgo;\n}\n\nconst ANALYTICS_INFO_DEBOUNCE_DELAY = process.env.NODE_ENV === 'development' ? 5_000 : 10_000;\nconst ANALYTICS_ERROR_AND_LOGS_DEBOUNCE_DELAY = 5_000;\n\nclass Analytics implements IAnalytics {\n    private readonly analyticsData?: AnalyticsOptions['analyticsData'];\n    private readonly service: IAnalyticsService;\n    private readonly eventsQueue: AnalyticsEventQueue;\n    private readonly storage = new Storage<CheckoutAttemptIdSessionStorage>('checkout-attempt-id', 'sessionStorage');\n    private readonly debouncedSendInfoEvents: () => void;\n    private readonly debouncedSendEvents: () => void;\n\n    private enabled: boolean = true;\n    private capturedCheckoutAttemptId?: string;\n    private isFlavorReported = false;\n\n    constructor({ service, eventQueue, enabled, analyticsData }: AnalyticsProps) {\n        this.service = service;\n        this.eventsQueue = eventQueue;\n\n        this.debouncedSendInfoEvents = debounce(this.sendEvents.bind(this), ANALYTICS_INFO_DEBOUNCE_DELAY);\n        this.debouncedSendEvents = debounce(this.sendEvents.bind(this), ANALYTICS_ERROR_AND_LOGS_DEBOUNCE_DELAY);\n\n        if (enabled !== undefined) this.enabled = enabled;\n        if (analyticsData) this.analyticsData = analyticsData;\n    }\n\n    public get checkoutAttemptId(): string {\n        return this.capturedCheckoutAttemptId;\n    }\n\n    public async setUp({\n        sessionId,\n        checkoutStage,\n        locale\n    }: { sessionId?: string; locale?: string; checkoutStage?: 'precheckout' | 'checkout' } = {}): Promise<void> {\n        try {\n            const checkoutAttemptIdSession = this.storage.get();\n            const isSessionReusable = isSessionCreatedUnderFifteenMinutes(checkoutAttemptIdSession);\n\n            const { applicationInfo, checkoutAttemptId: checkoutAttemptIdFromPayByLink } = processAnalyticsData(this.analyticsData);\n\n            const availableCheckoutAttemptId: string | undefined = isSessionReusable ? checkoutAttemptIdSession.id : checkoutAttemptIdFromPayByLink;\n\n            const payload: RequestAttemptIdPayload = {\n                version: LIBRARY_VERSION,\n                buildType: LIBRARY_BUNDLE_TYPE,\n                channel: 'Web',\n                platform: 'Web',\n                locale,\n                referrer: window.location.href,\n                screenWidth: window.screen.width,\n                checkoutStage: checkoutStage || 'checkout',\n                level: this.enabled ? 'all' : 'initial',\n                ...(applicationInfo && { applicationInfo }),\n                ...(sessionId && { sessionId }),\n                ...(availableCheckoutAttemptId && { checkoutAttemptId: availableCheckoutAttemptId })\n            };\n\n            this.capturedCheckoutAttemptId = await this.service.requestCheckoutAttemptId(payload);\n\n            this.storage.set({\n                id: this.capturedCheckoutAttemptId,\n                timestamp: isSessionReusable ? checkoutAttemptIdSession.timestamp : Date.now()\n            });\n        } catch (error: unknown) {\n            this.enabled = false;\n            console.warn('Analytics: Error setting up', error);\n        }\n    }\n\n    public sendAnalytics(event: AbstractAnalyticsEvent): void {\n        if (!this.enabled) {\n            return;\n        }\n\n        try {\n            this.addEventToQueue(event);\n        } catch (error: unknown) {\n            console.warn('Analytics: Error adding event to queue', error);\n        }\n    }\n\n    public async sendFlavor(flavor: 'dropin' | 'components'): Promise<void> {\n        if (!this.capturedCheckoutAttemptId) return;\n        if (this.isFlavorReported) return;\n\n        this.isFlavorReported = true;\n\n        try {\n            await this.service.reportIntegrationFlavor(flavor, this.capturedCheckoutAttemptId);\n        } catch (error) {\n            console.warn('Analytics: Error reporting flavor', error);\n        }\n    }\n\n    public flush(): void {\n        void this.sendEvents();\n    }\n\n    /**\n     * Info events don't have high priority, therefore  we add a delay in order to dispatch a batch of events\n     * Log/Error events are sent almost immediately. There is a debounce mechanism in place but the delay is very minimal\n     *\n     * @param event\n     * @private\n     */\n    private addEventToQueue(event: AbstractAnalyticsEvent): void {\n        this.eventsQueue.add(event);\n\n        if (event.getEventCategory() === AnalyticsEventCategory.info) {\n            this.debouncedSendInfoEvents();\n        } else {\n            this.debouncedSendEvents();\n        }\n    }\n\n    private async sendEvents(): Promise<void> {\n        if (!this.capturedCheckoutAttemptId || !this.enabled) {\n            return;\n        }\n\n        const payload: AnalyticsEventPayload = {\n            channel: 'Web',\n            platform: 'Web',\n            info: this.eventsQueue.infoEvents,\n            errors: this.eventsQueue.errorEvents,\n            logs: this.eventsQueue.logEvents\n        };\n\n        this.eventsQueue.clear();\n\n        try {\n            await this.service.sendEvents(payload, this.capturedCheckoutAttemptId);\n        } catch (error) {\n            console.warn('Analytics: Error sending events', error);\n        }\n    }\n}\n\nexport default Analytics;\n"],"names":["Analytics","checkoutAttemptId","this","capturedCheckoutAttemptId","setUp","sessionId","checkoutStage","locale","checkoutAttemptIdSession","storage","get","isSessionReusable","session","timestamp","fifteenMinutesAgo","Date","now","isSessionCreatedUnderFifteenMinutes","applicationInfo","checkoutAttemptIdFromPayByLink","processAnalyticsData","analyticsData","availableCheckoutAttemptId","id","payload","_object_spread","version","LIBRARY_VERSION","buildType","LIBRARY_BUNDLE_TYPE","channel","platform","referrer","window","location","href","screenWidth","screen","width","level","enabled","service","requestCheckoutAttemptId","set","error","console","warn","sendAnalytics","event","addEventToQueue","sendFlavor","flavor","isFlavorReported","reportIntegrationFlavor","flush","sendEvents","eventsQueue","add","getEventCategory","AnalyticsEventCategory","info","debouncedSendInfoEvents","debouncedSendEvents","infoEvents","errors","errorEvents","logs","logEvents","clear","constructor","eventQueue","_define_property","Storage","debounce","bind","undefined"],"mappings":"uZA2CA,MAAMA,EAuBF,qBAAWC,GACP,OAAOC,KAAKC,yBAChB,CAEA,WAAaC,EAAMC,UACfA,EAASC,cACTA,EAAaC,OACbA,GACqF,CAAA,GACrF,IACI,MAAMC,EAA2BN,KAAKO,QAAQC,MACxCC,EA5ClB,SAA6CC,GAEzC,KAAKA,aAAAA,EAAAA,EAASC,WAAW,OAAO,EAChC,MAAMC,EAAoBC,KAAKC,MAFD,IAG9B,OAAOJ,EAAQC,UAAYC,CAC/B,CAuCsCG,CAAoCT,IAExDU,gBAAEA,EAAiBjB,kBAAmBkB,GAAmCC,EAAqBlB,KAAKmB,eAEnGC,EAAiDX,EAAoBH,EAAyBe,GAAKJ,EAEnGK,oUAAmCC,CAAA,CACrCC,QAASC,EACTC,UAAWC,EACXC,QAAS,MACTC,SAAU,MACVxB,SACAyB,SAAUC,OAAOC,SAASC,KAC1BC,YAAaH,OAAOI,OAAOC,MAC3BhC,cAAeA,GAAiB,WAChCiC,MAAOrC,KAAKsC,QAAU,MAAQ,WAC1BtB,GAAmB,CAAEA,mBACrBb,GAAa,CAAEA,aACfiB,GAA8B,CAAErB,kBAAmBqB,IAG3DpB,KAAKC,gCAAkCD,KAAKuC,QAAQC,yBAAyBlB,GAE7EtB,KAAKO,QAAQkC,IAAI,CACbpB,GAAIrB,KAAKC,0BACTU,UAAWF,EAAoBH,EAAyBK,UAAYE,KAAKC,OAEjF,CAAE,MAAO4B,GACL1C,KAAKsC,SAAU,EACfK,QAAQC,KAAK,8BAA+BF,EAChD,CACJ,CAEOG,aAAAA,CAAcC,GACjB,GAAK9C,KAAKsC,QAIV,IACItC,KAAK+C,gBAAgBD,EACzB,CAAE,MAAOJ,GACLC,QAAQC,KAAK,yCAA0CF,EAC3D,CACJ,CAEA,gBAAaM,CAAWC,GACpB,GAAKjD,KAAKC,4BACND,KAAKkD,iBAAT,CAEAlD,KAAKkD,kBAAmB,EAExB,UACUlD,KAAKuC,QAAQY,wBAAwBF,EAAQjD,KAAKC,0BAC5D,CAAE,MAAOyC,GACLC,QAAQC,KAAK,oCAAqCF,EACtD,CAR2B,CAS/B,CAEOU,KAAAA,GACEpD,KAAKqD,YACd,CASQN,eAAAA,CAAgBD,GACpB9C,KAAKsD,YAAYC,IAAIT,GAEjBA,EAAMU,qBAAuBC,EAAuBC,KACpD1D,KAAK2D,0BAEL3D,KAAK4D,qBAEb,CAEA,gBAAcP,GACV,IAAKrD,KAAKC,4BAA8BD,KAAKsC,QACzC,OAGJ,MAAMhB,EAAiC,CACnCM,QAAS,MACTC,SAAU,MACV6B,KAAM1D,KAAKsD,YAAYO,WACvBC,OAAQ9D,KAAKsD,YAAYS,YACzBC,KAAMhE,KAAKsD,YAAYW,WAG3BjE,KAAKsD,YAAYY,QAEjB,UACUlE,KAAKuC,QAAQc,WAAW/B,EAAStB,KAAKC,0BAChD,CAAE,MAAOyC,GACLC,QAAQC,KAAK,kCAAmCF,EACpD,CACJ,CAzHA,WAAAyB,EAAY5B,QAAEA,EAAO6B,WAAEA,EAAU9B,QAAEA,EAAOnB,cAAEA,IAX5CkD,EAAArE,KAAiBmB,wBACjBkD,EAAArE,KAAiBuC,kBACjB8B,EAAArE,KAAiBsD,sBACjBe,EAAArE,KAAiBO,UAAU,IAAI+D,EAAyC,sBAAuB,mBAC/FD,EAAArE,KAAiB2D,kCACjBU,EAAArE,KAAiB4D,8BAEjBS,EAAArE,KAAQsC,WAAmB,GAC3B+B,EAAArE,KAAQC,oCACRoE,EAAArE,KAAQkD,oBAAmB,GAGvBlD,KAAKuC,QAAUA,EACfvC,KAAKsD,YAAcc,EAEnBpE,KAAK2D,wBAA0BY,EAASvE,KAAKqD,WAAWmB,KAAKxE,MAnBkB,KAoB/EA,KAAK4D,oBAAsBW,EAASvE,KAAKqD,WAAWmB,KAAKxE,MAnBjB,UAqBxByE,IAAZnC,IAAuBtC,KAAKsC,QAAUA,GACtCnB,IAAenB,KAAKmB,cAAgBA,EAC5C"}