{"version":3,"file":"Dropin.js","sources":["../../../../src/components/Dropin/Dropin.tsx"],"sourcesContent":["import { h } from 'preact';\nimport UIElement from '../internal/UIElement/UIElement';\nimport defaultProps from './defaultProps';\nimport DropinComponent from '../../components/Dropin/components/DropinComponent';\nimport { createElements, createStoredElements } from './elements';\nimport createInstantPaymentElements from './elements/createInstantPaymentElements';\nimport { hasOwnProperty } from '../../utils/hasOwnProperty';\nimport splitPaymentMethods from './elements/splitPaymentMethods';\nimport { TxVariants } from '../tx-variants';\n\nimport type { DropinConfiguration, InstantPaymentTypes, PaymentMethodsConfiguration } from './types';\nimport type { PaymentAction, PaymentAmount, PaymentResponseData } from '../../types/global-types';\nimport type { ICore } from '../../core/types';\nimport type { IDropin } from './types';\n\nconst SUPPORTED_INSTANT_PAYMENTS = ['paywithgoogle', 'googlepay', 'applepay'];\n\nclass DropinElement extends UIElement<DropinConfiguration> implements IDropin {\n    public static type = TxVariants.dropin;\n\n    protected static defaultProps = defaultProps;\n\n    public dropinRef = null;\n\n    private paymentMethodsConfiguration: PaymentMethodsConfiguration;\n    /**\n     * Reference to the component created from `handleAction` (Ex.: ThreeDS2Challenge)\n     */\n    public componentFromAction?: UIElement;\n\n    /**\n     * Reference to all payment method elements being rendered by Drop-in\n     */\n    public paymentMethodElements: UIElement[] = [];\n\n    constructor(checkout: ICore, props?: DropinConfiguration) {\n        super(checkout, props);\n        this.submit = this.submit.bind(this);\n        this.handleAction = this.handleAction.bind(this);\n        this.handleElementsCreated = this.handleElementsCreated.bind(this);\n\n        this.props.paymentMethodComponents.forEach(PaymentMethod => this.core.register(PaymentMethod));\n        this.paymentMethodsConfiguration = this.props.paymentMethodsConfiguration || {};\n    }\n\n    protected override reportIntegrationFlavor(): void {\n        void this.analytics.sendFlavor('dropin');\n    }\n\n    protected override storeElementRefOnCore() {\n        this.core.storeElementReference(this);\n    }\n\n    formatProps(props) {\n        return {\n            ...super.formatProps(props),\n            instantPaymentTypes: Array.from<InstantPaymentTypes>(new Set(props.instantPaymentTypes)).filter(value =>\n                SUPPORTED_INSTANT_PAYMENTS.includes(value)\n            )\n        };\n    }\n\n    get isValid() {\n        return !!this.dropinRef && !!this.dropinRef.state.activePaymentMethod && !!this.dropinRef.state.activePaymentMethod.isValid;\n    }\n\n    showValidation() {\n        if (this.dropinRef.state.activePaymentMethod) {\n            this.dropinRef.state.activePaymentMethod.showValidation();\n        }\n\n        return this;\n    }\n\n    public setStatus(status, props = {}): this {\n        this.dropinRef?.setStatus(status, props);\n        return this;\n    }\n\n    get activePaymentMethod() {\n        if (!this.dropinRef?.state && !this.dropinRef?.state.activePaymentMethod) {\n            return null;\n        }\n\n        return this.dropinRef.state.activePaymentMethod;\n    }\n\n    get data() {\n        if (!this.activePaymentMethod) {\n            return null;\n        }\n\n        return this.dropinRef.state.activePaymentMethod.data;\n    }\n\n    public displayFinalAnimation(type: 'success' | 'error') {\n        if (this.props.disableFinalAnimation) return;\n\n        this.dropinRef?.setStatus(type);\n    }\n\n    /**\n     * Calls the onSubmit event with the state of the activePaymentMethod\n     */\n    public override submit(): void {\n        if (!this.activePaymentMethod) {\n            throw new Error('No active payment method.');\n        }\n\n        if (!this.activePaymentMethod.isValid) {\n            this.activePaymentMethod.showValidation();\n        }\n\n        if (this.activePaymentMethod.isInstantPayment) {\n            this.closeActivePaymentMethod();\n        }\n\n        this.activePaymentMethod.submit();\n    }\n\n    /**\n     * Updates the amount in the props and propagates it to the AmountProvider. That way the children components can use the updated amount.\n     *\n     * This method **overrides** the parent one to specifically propagate the changes to all payment method elements.\n     *\n     * @param amount - Primary payment amount object\n     * @param secondaryAmount - Optional secondary amount for display purposes (e.g., converted currency)\n     * @internal\n     */\n    public override updateAmount(amount: PaymentAmount, secondaryAmount?: PaymentAmount): void {\n        this.props = {\n            ...this.props,\n            ...(amount && { amount }),\n            ...(secondaryAmount && { secondaryAmount })\n        };\n\n        this.amountProviderRef.current?.update(amount, secondaryAmount);\n\n        this.paymentMethodElements.forEach(element => {\n            element.updateAmount(amount, secondaryAmount);\n        });\n    }\n\n    /**\n     * Assign all elements created in the Component to the paymentMethodElements property\n     * @param elements\n     */\n    private handleElementsCreated(elements: UIElement[]) {\n        if (!elements || elements.length === 0) this.paymentMethodElements = [];\n        this.paymentMethodElements = elements;\n    }\n\n    /**\n     * Creates the Drop-in elements\n     */\n    private handleCreate = () => {\n        const { paymentMethodsConfiguration, showStoredPaymentMethods, showPaymentMethods, instantPaymentTypes } = this.props;\n\n        const { paymentMethods, storedPaymentMethods, instantPaymentMethods, fastlanePaymentMethod } = splitPaymentMethods(\n            this.core.paymentMethodsResponse,\n            instantPaymentTypes\n        );\n\n        const dropinProps = {\n            elementRef: this.elementRef,\n            isDropin: true\n        };\n\n        const elements = showPaymentMethods ? createElements(paymentMethods, paymentMethodsConfiguration, dropinProps, this.core) : [];\n        const instantPaymentElements = createInstantPaymentElements(instantPaymentMethods, paymentMethodsConfiguration, dropinProps, this.core);\n        const storedElements = showStoredPaymentMethods\n            ? createStoredElements(\n                  this.props.filterStoredPaymentMethods?.(storedPaymentMethods) ?? storedPaymentMethods,\n                  paymentMethodsConfiguration,\n                  dropinProps,\n                  this.core\n              )\n            : [];\n        const fastlanePaymentElement = fastlanePaymentMethod\n            ? createElements([fastlanePaymentMethod], paymentMethodsConfiguration, dropinProps, this.core)\n            : [];\n\n        return [storedElements, elements, instantPaymentElements, fastlanePaymentElement];\n    };\n\n    public handleAction(action: PaymentAction, props = {}): this | null {\n        if (!action || !action.type) {\n            if (hasOwnProperty(action, 'action') && hasOwnProperty(action, 'resultCode')) {\n                throw new Error(\n                    'handleAction::Invalid Action - the passed action object itself has an \"action\" property and ' +\n                        'a \"resultCode\": have you passed in the whole response object by mistake?'\n                );\n            }\n            throw new Error('handleAction::Invalid Action - the passed action object does not have a \"type\" property');\n        }\n\n        if (action.type !== 'redirect' && this.activePaymentMethod?.updateWithAction) {\n            return this.activePaymentMethod.updateWithAction(action);\n        }\n\n        if (this.elementRef instanceof DropinElement) {\n            props = {\n                ...this.elementRef.activePaymentMethod?.props,\n                ...props\n            };\n        }\n\n        const paymentAction: UIElement = this.core.createFromAction(action, {\n            ...props,\n            elementRef: this.elementRef, // maintain elementRef for 3DS2 flow\n            isDropin: true\n        });\n\n        if (paymentAction) {\n            this.setStatus(paymentAction.props.statusType, { component: paymentAction });\n            this.componentFromAction = paymentAction;\n            return this;\n        }\n\n        return null;\n    }\n\n    /**\n     * handleOrder is implemented so we don't trigger a callback like in the components\n     * @param response - PaymentResponse\n     */\n    protected handleOrder = ({ order }: PaymentResponseData): void => {\n        void this.updateParent({ order });\n    };\n\n    closeActivePaymentMethod() {\n        this.dropinRef.closeActivePaymentMethod();\n    }\n\n    protected handleKeyPress(e: h.JSX.TargetedKeyboardEvent<HTMLInputElement> | KeyboardEvent) {\n        if (e.key === 'Enter' || e.code === 'Enter') {\n            // If the active element has role=\"radio\", we're on a header in the PMList, in which case we don't want to validate the form, or, prevent the default behaviour\n            const isPMHeader = document?.activeElement?.getAttribute('role') === 'radio';\n            if (isPMHeader) {\n                return;\n            }\n            super.handleKeyPress(e);\n        }\n    }\n\n    protected onEnterKeyPressed(activeElement: Element, component: UIElement) {\n        // We want to have a ref to the activePM, if we can; not a ref to the Dropin\n        const pmComponent = this.activePaymentMethod ?? component;\n        this.activePaymentMethod?.onEnterKeyPressed(activeElement, pmComponent);\n    }\n\n    protected override componentToRender(): h.JSX.Element {\n        return (\n            <DropinComponent\n                {...this.props}\n                core={this.core}\n                elementRef={this.elementRef}\n                onCreateElements={this.handleCreate}\n                onElementsCreated={this.handleElementsCreated}\n                ref={dropinRef => {\n                    this.dropinRef = dropinRef;\n                }}\n            />\n        );\n    }\n}\n\nexport default DropinElement;\n"],"names":["SUPPORTED_INSTANT_PAYMENTS","DropinElement","UIElement","reportIntegrationFlavor","this","analytics","sendFlavor","storeElementRefOnCore","core","storeElementReference","formatProps","props","_object_spread_props","_object_spread","super","instantPaymentTypes","Array","from","Set","filter","value","includes","isValid","dropinRef","state","activePaymentMethod","showValidation","setStatus","status","_this_dropinRef","_this_dropinRef1","data","displayFinalAnimation","type","disableFinalAnimation","submit","Error","isInstantPayment","closeActivePaymentMethod","updateAmount","amount","secondaryAmount","_this_amountProviderRef_current","amountProviderRef","current","update","paymentMethodElements","forEach","element","handleElementsCreated","elements","length","handleAction","action","_this_activePaymentMethod","_this_elementRef_activePaymentMethod","hasOwnProperty","updateWithAction","elementRef","paymentAction","createFromAction","isDropin","statusType","component","componentFromAction","handleKeyPress","e","key","code","document","activeElement","getAttribute","onEnterKeyPressed","_this_activePaymentMethod1","pmComponent","componentToRender","h","DropinComponent","onCreateElements","handleCreate","onElementsCreated","ref","constructor","checkout","_define_property","paymentMethodsConfiguration","_this_props_filterStoredPaymentMethods","_this_props","showStoredPaymentMethods","showPaymentMethods","paymentMethods","storedPaymentMethods","instantPaymentMethods","fastlanePaymentMethod","splitPaymentMethods","paymentMethodsResponse","dropinProps","createElements","instantPaymentElements","createInstantPaymentElements","createStoredElements","filterStoredPaymentMethods","call","handleOrder","order","updateParent","bind","paymentMethodComponents","PaymentMethod","register","TxVariants","dropin","defaultProps"],"mappings":"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"}