{"version":3,"file":"GiftcardComponent.js","sources":["../../../../../src/components/Giftcard/components/GiftcardComponent.tsx"],"sourcesContent":["import { Component, FunctionComponent, h } from 'preact';\nimport SecuredFieldsProvider from '../../internal/SecuredFields/SFP/SecuredFieldsProvider';\nimport Alert from '../../internal/Alert';\nimport GiftcardResult from './GiftcardResult';\nimport { useCoreContext } from '../../../core/Context/CoreProvider';\nimport { GIFT_CARD } from '../../internal/SecuredFields/lib/constants';\nimport { GiftCardFields } from './GiftcardFields';\nimport { GiftcardFieldsProps, Placeholders } from './types';\nimport { useSRPanelForGiftcardErrors } from './useSRPanelForGiftcardErrors';\nimport { GiftCardBalanceCheckErrorType } from '../types';\nimport { PayButtonProps } from '../../internal/PayButton/PayButton';\nimport { useAmount } from '../../../core/Context/AmountProvider';\nimport type { AbstractAnalyticsEvent } from '../../../core/Analytics/events/AbstractAnalyticsEvent';\n\ninterface GiftcardComponentProps {\n    onChange: (state) => void;\n    onFocus: (event) => void;\n    onBlur: (event) => void;\n    makeBalanceCheck: (event) => void;\n    makePayment: (event) => void;\n    showPayButton: boolean;\n    payButton: (props: PayButtonProps) => h.JSX.Element;\n    pinRequired: boolean;\n    expiryDateRequired?: boolean;\n    fieldsLayoutComponent: FunctionComponent<GiftcardFieldsProps>;\n    placeholders?: Placeholders;\n    handleKeyPress?: (o: KeyboardEvent) => void;\n    onSubmitAnalytics?: (event: AbstractAnalyticsEvent) => void;\n}\n\nclass Giftcard extends Component<GiftcardComponentProps> {\n    public state = {\n        status: 'ready',\n        data: {},\n        balance: null,\n        transactionLimit: null,\n        focusedElement: false,\n        isValid: false,\n        sfpState: {},\n        isValidating: false,\n        transformedErrors: {}\n    };\n\n    public static defaultProps = {\n        pinRequired: true,\n        expiryDateRequired: false,\n        onChange: () => {},\n        onFocus: () => {},\n        onBlur: () => {},\n        fieldsLayoutComponent: GiftCardFields\n    };\n\n    public sfp: SecuredFieldsProvider;\n\n    /**\n     * Maps string error codes from SecuredFields to validation rule objects\n     */\n    public mapErrorsToValidationObjects = () => {\n        // Use the sfp reference to call mapErrorsToValidationRuleResult\n        if (!this.sfp) return {};\n        return this.sfp.mapErrorsToValidationRuleResult();\n    };\n\n    private updateTransformedErrors = (balanceCheckErrors?: Record<string, any>) => {\n        const transformedErrors = this.mapErrorsToValidationObjects();\n\n        const mergedErrors = { ...transformedErrors, ...balanceCheckErrors };\n\n        this.setState({ transformedErrors: mergedErrors });\n    };\n\n    public onChange = sfpState => {\n        this.setState({ sfpState }, () => this.updateTransformedErrors());\n\n        this.props.onChange({\n            data: sfpState.data,\n            isValid: sfpState.isSfpValid\n        });\n    };\n\n    public handleFocus = e => {\n        this.setState({ focusedElement: e.currentFocusObject });\n\n        const isFocused = e.focus === true;\n        if (isFocused) {\n            this.props.onFocus(e);\n        } else {\n            this.props.onBlur(e);\n        }\n    };\n\n    public setBalance = ({ balance, transactionLimit }) => {\n        this.setState({ balance, transactionLimit });\n    };\n\n    /**\n     * Generates balance check errors in the same format as SFP errors\n     * Compatible with the transformedErrors structure\n     */\n    private generateBalanceCheckErrors(errorType?: GiftCardBalanceCheckErrorType | null): Record<string, any> {\n        const balanceCheckErrors: Record<string, any> = {};\n\n        // This is the field that the error is associated with, only used for SR logic\n        const fieldToAnnounce = 'encryptedCardNumber';\n\n        // If errorType is null, clear errors\n        if (errorType === null) {\n            return balanceCheckErrors;\n        }\n\n        // Create error in the same format as SFP errors for consistency\n        balanceCheckErrors[fieldToAnnounce] = {\n            isValid: false,\n            errorMessage: `error.giftcard.${errorType}`,\n            error: errorType\n        };\n\n        return balanceCheckErrors;\n    }\n\n    /**\n     * Checks if a status represents a balance check error\n     */\n    private isBalanceCheckError(status: string): boolean {\n        return ['no-balance', 'card-error', 'currency-error'].includes(status);\n    }\n\n    /**\n     * Method called by GiftcardElement to set balance check errors only\n     */\n    public setBalanceCheckErrors = (errorType: GiftCardBalanceCheckErrorType | null): void => {\n        // Check if the errors should be displayed\n        if (this.isBalanceCheckError(errorType)) {\n            // Generate balance check errors in the style of useForm\n            // This is usefull because then we can use the same logic for SF and balance check errors\n            // Also we can use the same logic for SRPanel errors\n            const balanceCheckErrors = this.generateBalanceCheckErrors(errorType);\n            this.updateTransformedErrors(balanceCheckErrors);\n        }\n    };\n\n    public showValidation = () => {\n        this.setState({ isValidating: true });\n\n        // Validate SecuredFields\n        this.sfp?.showValidation();\n    };\n\n    public setIsValidating = (val: boolean) => {\n        this.setState({ isValidating: val });\n    };\n\n    render(props, { focusedElement, balance, transactionLimit, isValidating, transformedErrors }) {\n        const { i18n } = useCoreContext();\n        const { amount } = useAmount();\n\n        // Handle SRPanel errors in render with transformed error objects\n        useSRPanelForGiftcardErrors({\n            errors: transformedErrors,\n            isValidating,\n            setIsValidating: this.setIsValidating,\n            sfp: this.sfp\n        });\n\n        const transactionAmount = transactionLimit?.value < balance?.value ? transactionLimit : balance;\n        const hasEnoughBalance = transactionAmount?.value >= amount?.value;\n\n        if (transactionAmount && hasEnoughBalance) {\n            return (\n                <GiftcardResult\n                    balance={balance}\n                    transactionLimit={transactionLimit}\n                    makePayment={props.makePayment}\n                    status={this.state.status}\n                    makeBalanceCheck={props.makeBalanceCheck}\n                    showPayButton={this.props.showPayButton}\n                    payButton={this.props.payButton}\n                />\n            );\n        }\n\n        const getCardErrorMessage = sfpState => {\n            if (sfpState.errors.encryptedCardNumber) return i18n.get(sfpState.errors.encryptedCardNumber);\n\n            // This logic is a bit of a hack, but it's the only way to get the error message for balance check errors\n            // In the future we should move this logic to useForm\n            if (transformedErrors.encryptedCardNumber) {\n                return i18n.get(transformedErrors.encryptedCardNumber.errorMessage);\n            }\n\n            return null;\n        };\n\n        return (\n            <div className=\"adyen-checkout__giftcard\">\n                {this.state.status === 'error' && <Alert icon={'cross'}>{i18n.get('error.message.unknown')}</Alert>}\n\n                <SecuredFieldsProvider\n                    {...this.props}\n                    ref={ref => {\n                        this.sfp = ref;\n                    }}\n                    onChange={this.onChange}\n                    onFocus={this.handleFocus}\n                    onSubmitAnalytics={props.onSubmitAnalytics}\n                    type={GIFT_CARD}\n                    componentType={props.type}\n                    render={({ setRootNode, setFocusOn }, sfpState) =>\n                        this.props.fieldsLayoutComponent({\n                            i18n: i18n,\n                            pinRequired: this.props.pinRequired,\n                            focusedElement: focusedElement,\n                            getCardErrorMessage: getCardErrorMessage,\n                            setRootNode: setRootNode,\n                            setFocusOn: setFocusOn,\n                            sfpState: sfpState\n                        })\n                    }\n                />\n\n                {this.props.showPayButton &&\n                    this.props.payButton({\n                        status: this.state.status,\n                        onClick: this.props.makeBalanceCheck,\n                        label: i18n.get('applyGiftcard')\n                    })}\n            </div>\n        );\n    }\n}\n\nexport default Giftcard;\n"],"names":["Giftcard","Component","generateBalanceCheckErrors","errorType","balanceCheckErrors","isValid","errorMessage","error","isBalanceCheckError","status","includes","render","props","focusedElement","balance","transactionLimit","isValidating","transformedErrors","i18n","useCoreContext","amount","useAmount","useSRPanelForGiftcardErrors","errors","setIsValidating","this","sfp","transactionAmount","value","hasEnoughBalance","h","GiftcardResult","makePayment","state","makeBalanceCheck","showPayButton","payButton","getCardErrorMessage","sfpState","encryptedCardNumber","get","div","className","Alert","icon","SecuredFieldsProvider","ref","onChange","onFocus","handleFocus","onSubmitAnalytics","type","GIFT_CARD","componentType","setRootNode","setFocusOn","fieldsLayoutComponent","pinRequired","onClick","label","super","args","_define_property","data","mapErrorsToValidationObjects","mapErrorsToValidationRuleResult","updateTransformedErrors","mergedErrors","_object_spread","setState","isSfpValid","e","currentFocusObject","focus","onBlur","setBalance","setBalanceCheckErrors","showValidation","_this_sfp","val","defaultProps","expiryDateRequired","GiftCardFields"],"mappings":"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"}