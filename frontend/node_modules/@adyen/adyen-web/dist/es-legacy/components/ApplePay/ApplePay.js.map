{"version":3,"file":"ApplePay.js","sources":["../../../../src/components/ApplePay/ApplePay.tsx"],"sourcesContent":["import { h } from 'preact';\nimport UIElement from '../internal/UIElement/UIElement';\nimport ApplePayButton from './components/ApplePayButton';\nimport ApplePayService from './services/ApplePayService';\nimport base64 from '../../utils/base64';\nimport defaultProps from './defaultProps';\nimport { httpPost } from '../../core/Services/http';\nimport { preparePaymentRequest } from './utils/payment-request';\nimport AdyenCheckoutError from '../../core/Errors/AdyenCheckoutError';\nimport { DecodeObject } from '../../types/global-types';\nimport { TxVariants } from '../tx-variants';\nimport { sanitizeResponse, verifyPaymentDidNotFail } from '../internal/UIElement/utils';\nimport { resolveSupportedVersion } from './utils/resolve-supported-version';\nimport { formatApplePayContactToAdyenAddressFormat } from './utils/format-applepay-contact-to-adyen-format';\nimport { mapBrands } from './utils/map-adyen-brands-to-applepay-brands';\nimport ApplePaySdkLoader from './services/ApplePaySdkLoader';\nimport { detectInIframe } from '../../utils/detectInIframe';\nimport type { ApplePayConfiguration, ApplePayElementData, ApplePayPaymentOrderDetails, ApplePaySessionRequest } from './types';\nimport type { ICore } from '../../core/types';\nimport type { PaymentResponseData, RawPaymentResponse } from '../../types/global-types';\nimport { AnalyticsInfoEvent, InfoEventType, UiTarget } from '../../core/Analytics/events/AnalyticsInfoEvent';\n\nconst LATEST_APPLE_PAY_VERSION = 14;\n\nclass ApplePayElement extends UIElement<ApplePayConfiguration> {\n    public static type = TxVariants.applepay;\n\n    protected static defaultProps = defaultProps;\n\n    private sdkLoader: ApplePaySdkLoader;\n    private applePayVersionNumber: number = undefined;\n\n    constructor(checkout: ICore, props?: ApplePayConfiguration) {\n        super(checkout, props);\n\n        const { isExpress, onShippingContactSelected, onShippingMethodSelected } = this.props;\n\n        if (isExpress === false && (onShippingContactSelected || onShippingMethodSelected)) {\n            throw new AdyenCheckoutError(\n                'IMPLEMENTATION_ERROR',\n                'ApplePay - You must set \"isExpress\" flag to \"true\" in order to use \"onShippingContactSelected\" and/or \"onShippingMethodSelected\" callbacks'\n            );\n        }\n\n        this.startSession = this.startSession.bind(this);\n        this.submit = this.submit.bind(this);\n        this.validateMerchant = this.validateMerchant.bind(this);\n        this.collectOrderTrackingDetailsIfNeeded = this.collectOrderTrackingDetailsIfNeeded.bind(this);\n        this.handleAuthorization = this.handleAuthorization.bind(this);\n        this.defineApplePayVersionNumber = this.defineApplePayVersionNumber.bind(this);\n        this.configureApplePayWebOptions = this.configureApplePayWebOptions.bind(this);\n\n        this.sdkLoader = new ApplePaySdkLoader({ analytics: this.analytics });\n\n        void this.sdkLoader\n            .load()\n            .then(this.defineApplePayVersionNumber)\n            .then(this.configureApplePayWebOptions)\n            .catch(error => {\n                this.handleError(error);\n            });\n    }\n\n    /**\n     * Formats the component props\n     */\n    protected override formatProps(props: ApplePayConfiguration): ApplePayConfiguration {\n        // @ts-ignore TODO: Fix brands prop\n        const supportedNetworks = props.brands?.length ? mapBrands(props.brands) : props.supportedNetworks;\n\n        return {\n            ...props,\n            configuration: props.configuration,\n            supportedNetworks,\n            buttonLocale: props.buttonLocale ?? props.i18n?.locale,\n            totalPriceLabel: props.totalPriceLabel || props.configuration?.merchantName,\n            renderApplePayCodeAs: props.renderApplePayCodeAs ?? (detectInIframe() ? 'window' : 'modal')\n        };\n    }\n\n    /**\n     * Formats the component data output\n     */\n    protected override formatData(): ApplePayElementData {\n        const { applePayToken, billingAddress, deliveryAddress } = this.state;\n        const { isExpress } = this.props;\n\n        return {\n            paymentMethod: {\n                type: ApplePayElement.type,\n                applePayToken,\n                ...(isExpress && { subtype: 'express' })\n            },\n            ...(billingAddress && { billingAddress }),\n            ...(deliveryAddress && { deliveryAddress })\n        };\n    }\n\n    protected override beforeRender(configSetByMerchant?: ApplePayConfiguration) {\n        const event = new AnalyticsInfoEvent({\n            type: InfoEventType.rendered,\n            component: this.type,\n            configData: { ...configSetByMerchant, showPayButton: this.props.showPayButton },\n            ...(configSetByMerchant?.isExpress && { isExpress: configSetByMerchant.isExpress }),\n            ...(configSetByMerchant?.expressPage && { expressPage: configSetByMerchant.expressPage })\n        });\n\n        this.analytics.sendAnalytics(event);\n    }\n\n    public override submit = (): void => {\n        if (this.props.isInstantPayment) {\n            const event = new AnalyticsInfoEvent({ component: this.type, type: InfoEventType.selected, target: UiTarget.instantPaymentButton });\n            this.submitAnalytics(event);\n        }\n        void this.startSession();\n    };\n\n    public get isValid(): boolean {\n        return true;\n    }\n\n    /**\n     * This API is only intended for upstreaming or defaulting to Apple Pay, all other scenarios should continue to\n     * use canMakePayments(). For Safari browsers, this API will indicate whether there is a card available to make\n     * payments. For third-party browsers a new status of paymentCredentialStatusUnknown will be returned. This does\n     * not mean there are no cards available, it means the status cannot be determined and as such defaulting\n     * and upstreaming should still be considered.\n     *\n     * {@link https://developer.apple.com/documentation/apple_pay_on_the_web/applepaysession/4440085-applepaycapabilities}\n     * @param merchantIdentifier\n     */\n    public async applePayCapabilities(merchantIdentifier?: string): Promise<ApplePayJS.PaymentCredentialStatusResponse> {\n        const identifier = merchantIdentifier || this.props.configuration.merchantId;\n\n        try {\n            await this.sdkLoader.isSdkLoaded();\n            return await ApplePaySession?.applePayCapabilities(identifier);\n        } catch (error) {\n            throw new AdyenCheckoutError('ERROR', 'Apple Pay: Error when requesting applePayCapabilities()', { cause: error });\n        }\n    }\n\n    /**\n     * Determines if Apple Pay component can be displayed or not\n     */\n    public override async isAvailable(): Promise<void> {\n        if (window.location.protocol !== 'https:') {\n            return Promise.reject(new AdyenCheckoutError('IMPLEMENTATION_ERROR', 'Trying to start an Apple Pay session from an insecure document'));\n        }\n\n        try {\n            await this.sdkLoader.isSdkLoaded();\n\n            if (ApplePaySession?.canMakePayments()) {\n                return Promise.resolve();\n            }\n\n            return Promise.reject(new AdyenCheckoutError('ERROR', 'Apple Pay is not available on this device'));\n        } catch (error) {\n            return Promise.reject(new AdyenCheckoutError('ERROR', 'Apple Pay SDK failed to load', { cause: error }));\n        }\n    }\n\n    /**\n     * Sets the Apple Pay version available for the shopper.\n     * This code needs to be executed once the  Apple Pay SDK is fully loaded\n     * @private\n     */\n    private defineApplePayVersionNumber() {\n        if (window.location.protocol !== 'https:') return;\n        this.applePayVersionNumber = this.props.version || resolveSupportedVersion(LATEST_APPLE_PAY_VERSION);\n    }\n\n    /**\n     * Sets the configuration/callbacks that pertain to the Apple Pay code overlay/modal.\n     * @private\n     */\n    private configureApplePayWebOptions() {\n        if (window.ApplePayWebOptions) {\n            const { renderApplePayCodeAs, onApplePayCodeClose } = this.props;\n\n            window.ApplePayWebOptions.set({\n                renderApplePayCodeAs,\n                ...(onApplePayCodeClose && { onApplePayCodeClose })\n            });\n        }\n    }\n\n    private startSession() {\n        const { onValidateMerchant, onPaymentMethodSelected, onShippingMethodSelected, onShippingContactSelected } = this.props;\n\n        const paymentRequest = preparePaymentRequest({\n            companyName: this.props.configuration.merchantName,\n            countryCode: this.core.options.countryCode,\n            ...this.props\n        });\n\n        const session = new ApplePayService(paymentRequest, {\n            version: this.applePayVersionNumber,\n            onError: (error: unknown) => {\n                this.handleError(\n                    new AdyenCheckoutError('ERROR', 'ApplePay - Something went wrong on ApplePayService', {\n                        cause: error\n                    })\n                );\n            },\n            onCancel: event => {\n                this.handleError(new AdyenCheckoutError('CANCEL', 'ApplePay UI dismissed', { cause: event }));\n            },\n            onPaymentMethodSelected,\n            onShippingMethodSelected,\n            onShippingContactSelected,\n            onValidateMerchant: onValidateMerchant || this.validateMerchant,\n            onPaymentAuthorized: (resolve, reject, event) => {\n                const billingAddress = formatApplePayContactToAdyenAddressFormat(event.payment.billingContact);\n                const deliveryAddress = formatApplePayContactToAdyenAddressFormat(event.payment.shippingContact, true);\n\n                this.setState({\n                    applePayToken: btoa(JSON.stringify(event.payment.token.paymentData)),\n                    authorizedEvent: event,\n                    ...(billingAddress && { billingAddress }),\n                    ...(deliveryAddress && { deliveryAddress })\n                });\n\n                this.handleAuthorization()\n                    .then(this.makePaymentsCall)\n                    .then(sanitizeResponse)\n                    .then(verifyPaymentDidNotFail)\n                    .then(this.collectOrderTrackingDetailsIfNeeded)\n                    .then(({ paymentResponse, orderDetails }) => {\n                        resolve({\n                            status: ApplePaySession.STATUS_SUCCESS,\n                            ...(orderDetails && { orderDetails })\n                        });\n                        return paymentResponse;\n                    })\n                    .then(paymentResponse => {\n                        this.handleResponse(paymentResponse);\n                    })\n                    .catch((paymentResponse?: RawPaymentResponse) => {\n                        const errors = paymentResponse?.error?.applePayError;\n\n                        reject({\n                            status: ApplePaySession.STATUS_FAILURE,\n                            errors: errors ? (Array.isArray(errors) ? errors : [errors]) : undefined\n                        });\n\n                        const responseWithError: RawPaymentResponse = {\n                            ...paymentResponse,\n                            error: {\n                                applePayError: errors\n                            }\n                        };\n\n                        this.handleFailedResult(responseWithError);\n                    });\n            }\n        });\n\n        return new Promise<void>((resolve, reject) => this.props.onClick(resolve, reject))\n            .then(() => {\n                session.begin();\n            })\n            .catch(() => ({\n                // Swallow exception triggered by onClick reject\n            }));\n    }\n\n    /**\n     * Call the 'onAuthorized' callback if available.\n     * Must be resolved/reject for the payment flow to continue\n     *\n     * @private\n     */\n    private async handleAuthorization(): Promise<void> {\n        return new Promise<void>((resolve, reject) => {\n            if (!this.props.onAuthorized) {\n                resolve();\n            }\n\n            const { authorizedEvent, billingAddress, deliveryAddress } = this.state;\n\n            this.props.onAuthorized(\n                {\n                    authorizedEvent,\n                    ...(billingAddress && { billingAddress }),\n                    ...(deliveryAddress && { deliveryAddress })\n                },\n                { resolve, reject }\n            );\n        }).catch((error?: ApplePayJS.ApplePayError) => {\n            // Format error in a way that the 'catch' of the 'onPaymentAuthorize' block accepts it\n            const data = { error: { applePayError: error } };\n            return Promise.reject(data);\n        });\n    }\n\n    /**\n     * Verify if the 'onOrderTrackingRequest' is provided. If so, triggers the callback expecting an\n     * Apple Pay order details back\n     *\n     * @private\n     */\n    private async collectOrderTrackingDetailsIfNeeded(\n        paymentResponse: PaymentResponseData\n    ): Promise<{ orderDetails?: ApplePayPaymentOrderDetails; paymentResponse: PaymentResponseData }> {\n        return new Promise<ApplePayPaymentOrderDetails | void>((resolve, reject) => {\n            if (!this.props.onOrderTrackingRequest) {\n                return resolve();\n            }\n\n            this.props.onOrderTrackingRequest(resolve, reject);\n        })\n            .then(orderDetails => {\n                return {\n                    paymentResponse,\n                    ...(orderDetails && { orderDetails })\n                };\n            })\n            .catch(() => {\n                return { paymentResponse };\n            });\n    }\n\n    private async validateMerchant(resolve: (merchantSession: any) => void, reject: (error: string) => void) {\n        const { hostname } = window.location;\n        const { clientKey, configuration, loadingContext, initiative, domainName } = this.props;\n        const { merchantName, merchantId } = configuration;\n        const path = `v1/applePay/sessions?clientKey=${clientKey}`;\n        const options = { loadingContext, path };\n        const request: ApplePaySessionRequest = {\n            displayName: merchantName,\n            domainName: domainName || hostname,\n            initiative,\n            merchantIdentifier: merchantId\n        };\n\n        try {\n            const response = await httpPost(options, request);\n            const decodedData: DecodeObject = base64.decode(response.data);\n            if (!decodedData.success) {\n                reject('Could not decode Apple Pay session');\n            } else {\n                const session = JSON.parse(decodedData.data);\n                resolve(session);\n            }\n        } catch (e) {\n            reject('Could not get Apple Pay session');\n        }\n    }\n\n    protected override componentToRender(): h.JSX.Element {\n        if (!this.props.showPayButton) {\n            return null;\n        }\n\n        return (\n            <ApplePayButton\n                buttonStyle={this.props.buttonColor}\n                buttonType={this.props.buttonType}\n                buttonLocale={this.props.buttonLocale}\n                onClick={this.submit}\n            />\n        );\n    }\n}\n\nexport default ApplePayElement;\n"],"names":["ApplePayElement","UIElement","formatProps","props","supportedNetworks","brands","length","mapBrands","_object_spread_props","_object_spread","configuration","buttonLocale","i18n","locale","totalPriceLabel","merchantName","renderApplePayCodeAs","detectInIframe","formatData","applePayToken","billingAddress","deliveryAddress","this","state","isExpress","paymentMethod","type","subtype","beforeRender","configSetByMerchant","event","AnalyticsInfoEvent","InfoEventType","rendered","component","configData","showPayButton","expressPage","analytics","sendAnalytics","isValid","applePayCapabilities","merchantIdentifier","identifier","merchantId","ApplePaySession","sdkLoader","isSdkLoaded","error","AdyenCheckoutError","cause","isAvailable","window","location","protocol","Promise","reject","canMakePayments","resolve","defineApplePayVersionNumber","applePayVersionNumber","version","resolveSupportedVersion","configureApplePayWebOptions","ApplePayWebOptions","onApplePayCodeClose","set","startSession","onValidateMerchant","onPaymentMethodSelected","onShippingMethodSelected","onShippingContactSelected","paymentRequest","preparePaymentRequest","companyName","countryCode","core","options","session","ApplePayService","onError","handleError","onCancel","validateMerchant","onPaymentAuthorized","formatApplePayContactToAdyenAddressFormat","payment","billingContact","shippingContact","setState","btoa","JSON","stringify","token","paymentData","authorizedEvent","handleAuthorization","then","makePaymentsCall","sanitizeResponse","verifyPaymentDidNotFail","collectOrderTrackingDetailsIfNeeded","paymentResponse","orderDetails","status","STATUS_SUCCESS","handleResponse","catch","errors","applePayError","STATUS_FAILURE","Array","isArray","undefined","responseWithError","handleFailedResult","onClick","begin","onAuthorized","data","onOrderTrackingRequest","hostname","clientKey","loadingContext","initiative","domainName","path","request","displayName","response","httpPost","decodedData","base64","decode","success","parse","e","componentToRender","h","ApplePayButton","buttonStyle","buttonColor","buttonType","submit","constructor","checkout","super","_define_property","isInstantPayment","selected","target","UiTarget","instantPaymentButton","submitAnalytics","bind","ApplePaySdkLoader","load","TxVariants","applepay","defaultProps"],"mappings":"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"}