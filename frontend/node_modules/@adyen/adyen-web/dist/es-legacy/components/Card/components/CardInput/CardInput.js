import{createElement as e,Fragment as r}from"../../../../external/preact/dist/preact.js";import{useRef as t,useMemo as n,useState as o,useCallback as s,useEffect as a}from"../../../../external/preact/hooks/dist/hooks.js";import i from"../../../internal/SecuredFields/SFP/SecuredFieldsProvider.js";import l from"./defaultProps.js";import{AddressModeOptions as d}from"./types.js";import{DATE_POLICY_REQUIRED as u,CVC_POLICY_REQUIRED as c,ENCRYPTED_CARD_NUMBER as m}from"../../../internal/SecuredFields/lib/constants.js";import{cardInputValidationRules as p,cardInputFormatters as y,getRuleByNameAndMode as f}from"./validate.js";import b from"../../../internal/SecuredFields/binLookup/extensions.js";import h from"../../../../utils/useForm/useForm.js";import{handlePartialAddressMode as g,extractPropsForSFP as S,getLayout as N,extractPropsForCardFields as A}from"./utils.js";import v from"../../../internal/Address/Specifications.js";import{StoredCardFieldsWrapper as j}from"./components/StoredCardFieldsWrapper.js";import{CardFieldsWrapper as F}from"./components/CardFieldsWrapper.js";import{getAutoJumpHandler as O,getFocusHandler as C,getAddressHandler as w}from"./handlers.js";import P from"../../../../_virtual/index.js";import{getPartialAddressValidationRules as k}from"../../../internal/Address/validate.js";import B from"../../../../core/Context/useImage.js";import{getArrayDifferences as E}from"../../../../utils/arrayUtils.js";import R from"../../../internal/FormInstruction/FormInstruction.js";import{PREFIX as x}from"../../../internal/Icon/constants.js";import I from"./useSRPanelForCardInputErrors.js";import V from"../Fastlane/FastlaneSignup.js";import{fieldTypeToSnakeCase as D}from"../../../internal/SecuredFields/utils.js";import{getErrorMessageFromCode as q}from"../../../../core/Errors/utils.js";import{SF_ErrorCodes as M}from"../../../../core/Errors/constants.js";import{usePrevious as _}from"../../../../utils/hookUtils.js";import{AnalyticsInfoEvent as L,InfoEventType as T,UiTarget as K}from"../../../../core/Analytics/events/AnalyticsInfoEvent.js";function U(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function H(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{},n=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.forEach(function(r){U(e,r,t[r])})}return e}function z(e,r){return r=null!=r?r:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):function(e){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);r.push.apply(r,t)}return r}(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}),e}const W=l=>{var U,W,$,G;const J=t(null),Q=t(!1),X=B(),Y=t(null),Z=e=>{Y.current=e},ee=t({});Object.keys(ee.current).length||l.setComponentRef(ee.current);const re=t(0),te=t(!1),ne=n(()=>new v(l.specifications),[l.specifications]);ee.current.sfp=J;const[oe,se]=o("ready"),[ae,ie]=o({}),[le,de]=o(H({},l.holderNameRequired&&{holderName:!1})),[ue,ce]=o(H({},l.hasHolderName&&{holderName:null!==(U=l.data.holderName)&&void 0!==U?U:""})),[me,pe]=o(""),[ye,fe]=o(!1),[be,he]=o(u),[ge,Se]=o(c),[Ne,Ae]=o(null),[ve,je]=o([]),[Fe,Oe]=o(l.storedPaymentMethodId?l.brand:""),Ce=l.billingAddressMode!==d.none&&l.billingAddressRequired,we=g(l.billingAddressMode),Pe=t(we&&(null===(G=l.data)||void 0===G||null===($=G.billingAddress)||void 0===$?void 0:$.country)),[ke,Be]=o(!1),[Ee,Re]=o(Ce?l.data.billingAddress:null),[xe,Ie]=o(!1),[Ve,De]=o(""),[qe,Me]=o({value:null}),[_e,Le]=o(null),[Te,Ke]=o("card"),[Ue,He]=o(!1),{handleChangeFor:ze,triggerValidation:We,data:$e,valid:Ge,errors:Je,setSchema:Qe,setData:Xe,setValid:Ye,setErrors:Ze}=h({schema:[],defaultData:l.data,formatters:y,rules:p}),er=!(!Object.keys(l.installmentOptions).length||l.fundingSource&&"credit"!==l.fundingSource),rr=null===(W=l.showInstallmentAmounts)||void 0===W||W,tr="kr"===(null!=Ne?Ne:l.countryCode),nr=l.configuration.koreanAuthenticationRequired&&tr,or=xe&&"auto"===l.configuration.socialSecurityNumberMode||"show"===l.configuration.socialSecurityNumberMode,sr=(e,r)=>{l.onFocus({fieldType:e,event:r})},ar=(e,r)=>{l.onBlur({fieldType:e,event:r})},ir=s(e=>{Ke(e.brand),l.onBrand(e)},[]),lr=C(pe,sr,ar),dr=()=>N(H({props:l,showKCP:nr,showBrazilianSSN:or},l.billingAddressRequired&&{countrySpecificSchemas:ne.getAddressSchemaForCountry(null==Ee?void 0:Ee.country),billingAddressRequiredFields:l.billingAddressRequiredFields})),ur=s(e=>{const r="webInternalElement"!==e.fieldType?e.fieldType:e.name;Le(r)},[]),cr=w(Xe,Ye,Ze),mr=O(te,J,dr()),pr=s(e=>{yr(e)},[Ue,He]),yr=e=>{e.status&&("loading"==e.status?He(!1):He(!0))},fr=n(()=>b(l,{sfp:J},{dualBrandSelectElements:ve,setDualBrandSelectElements:je,setSelectedBrandValue:Oe,issuingCountryCode:Ne,setIssuingCountryCode:Ae},re),[ve,Ne]);ee.current.showValidation=()=>{Q.current=!0,null==gr||gr(),J.current.showValidation(),We(["holderName","socialSecurityNumber","taxNumber"]),(null==Y?void 0:Y.current)&&Y.current.showValidation()},ee.current.processBinLookupResponse=(e,r)=>{fr.processBinLookup(e,r)},ee.current.setStatus=se,a(()=>(ee.current.setFocusOn=J.current.setFocusOn,ee.current.updateStyles=J.current.updateStyles,ee.current.handleUnsupportedCard=J.current.handleUnsupportedCard,()=>{J.current.destroy()}),[]),a(()=>{const e=[...l.hasHolderName?["holderName"]:[],...or?["socialSecurityNumber"]:[],...nr?["taxNumber"]:[],...Ce?["billingAddress"]:[]];Qe(e)},[l.hasHolderName,or,nr]),a(()=>{var e;ce(z(H({},ue),{holderName:null!==(e=$e.holderName)&&void 0!==e?e:"",taxNumber:$e.taxNumber})),De($e.socialSecurityNumber),Ce&&Re(H({},$e.billingAddress)),de(z(H({},le),{holderName:!l.holderNameRequired||Ge.holderName,socialSecurityNumber:!!Ge.socialSecurityNumber&&Ge.socialSecurityNumber,taxNumber:!!Ge.taxNumber&&Ge.taxNumber,billingAddress:!!Ge.billingAddress&&Ge.billingAddress}));const r=!!Je.billingAddress&&Object.entries(Je.billingAddress).reduce((e,[,r])=>e||null!=r,!1);ie(z(H({},ae),{holderName:l.holderNameRequired&&Je.holderName?Je.holderName:null,socialSecurityNumber:or&&Je.socialSecurityNumber?Je.socialSecurityNumber:null,taxNumber:nr&&Je.taxNumber?Je.taxNumber:null,billingAddress:Ce&&r?Je.billingAddress:null}))},[$e,Ge,Je]);const{sortedErrorList:br,previousSortedErrors:hr,clearSRPanel:gr}=I({errors:ae,props:l,isValidating:Q,retrieveLayout:dr,specifications:ne,billingAddress:Ee,sfp:J});a(()=>{if(br){const e=E(br,hr,"field");null==e||e.forEach(e=>{const r=new L({component:l.type,type:T.validationError,target:D(e.field),validationErrorCode:e.errorCode,validationErrorMessage:q(e.errorCode,M)});l.onSubmitAnalytics(r)})}},[br]),a(()=>{const e=le.holderName,r=ye,t=!Ce||le.billingAddress,n=!nr||!!le.taxNumber&&!!le.encryptedPassword,o=!or||!!le.socialSecurityNumber,s=r&&e&&t&&n&&o,a=J.current.mapErrorsToValidationRuleResult(),i=H({},ae,a);l.onChange({data:ue,valid:le,errors:i,isValid:s,billingAddress:Ee,selectedBrandValue:Fe,storePaymentMethod:ke,socialSecurityNumber:Ve,installments:qe})},[ue,le,ae,Fe,ke,qe]),a(()=>{if(ve.length>0&&ve){const e=ve.map(e=>e.id),r=e[0],t=e.toString(),n=new L({component:l.type,type:T.displayed,target:K.dualBrandButton,brand:r,configData:{dualBrands:t}});l.onSubmitAnalytics(n)}},[ve]);const Sr=_(Fe);a(()=>{if((null==Sr?void 0:Sr.length)&&(null==Fe?void 0:Fe.length)){const e=new L({component:l.type,type:T.selected,target:K.dualBrandButton,brand:Fe});l.onSubmitAnalytics(e)}},[Fe]);const Nr=l.storedPaymentMethodId?j:F;return e(r,null,e(i,z(H({ref:J},S(l)),{styles:H({},l.styles),koreanAuthenticationRequired:l.configuration.koreanAuthenticationRequired,hasKoreanFields:!(!l.configuration.koreanAuthenticationRequired||"kr"!==l.countryCode),onSubmitAnalytics:l.onSubmitAnalytics,onChange:(e,r)=>{if(e.autoCompleteName){if(!l.hasHolderName)return;const r=f("holderName","blur")(e.autoCompleteName)?e.autoCompleteName:null;return void(r&&(Xe("holderName",r),Ye("holderName",!0),Ze("holderName",null)))}l.autoFocus&&re.current>0&&"handleOnFieldValid"===(null==r?void 0:r.event)&&(null==r?void 0:r.fieldType)===m&&e.valid.encryptedCardNumber&&mr(),ce(H({},ue,e.data)),ie(H({},ae,e.errors)),de(H({},le,e.valid)),fe(e.isSfpValid),Se(e.cvcPolicy),Ie(e.showSocialSecurityNumber),he(e.expiryDatePolicy)},onBrand:ir,onFocus:lr,onStateUpdate:pr,type:l.brand,componentType:l.type,disableIOSArrowKeys:l.disableIOSArrowKeys?ur:null,render:({setRootNode:r,setFocusOn:t},n)=>{var o;return e("div",{ref:r,className:P({"adyen-checkout__card-input":!0,"adyen-checkout-card-input__wrapper":!0,[`adyen-checkout__card-input--${null!==(o=l.fundingSource)&&void 0!==o?o:"credit"}`]:!0,"adyen-checkout__card-input--loading":"loading"===oe}),role:"form"},Ue&&e(R,null),e(Nr,z(H({},A(l)),{data:ue,valid:le,errors:ae,handleChangeFor:ze,focusedElement:me,setFocusOn:t,sfpState:n,cvcPolicy:ge,hasInstallments:er,showAmountsInInstallments:rr,handleInstallments:Me,brandsIcons:l.brandsIcons,formData:$e,formErrors:Je,formValid:Ge,expiryDatePolicy:be,dualBrandSelectElements:ve,extensions:fr,selectedBrandValue:Fe,showKCP:nr,showBrazilianSSN:or,socialSecurityNumber:Ve,handleOnStoreDetails:Be,setAddressRef:Z,billingAddress:Ee,billingAddressValidationRules:we&&k(Pe.current),partialAddressSchema:we,handleAddress:cr,onAddressLookup:l.onAddressLookup,onAddressSelected:l.onAddressSelected,addressSearchDebounceMs:l.addressSearchDebounceMs,iOSFocusedField:_e,onFieldFocusAnalytics:sr,onFieldBlurAnalytics:ar})))}})),l.fastlaneConfiguration&&e(V,z(H({},l.fastlaneConfiguration),{currentDetectedBrand:Te,onChange:l.onChange,onSubmitAnalytics:l.onSubmitAnalytics,type:l.type})),Ue&&l.showPayButton&&l.payButton({status:oe,variant:l.isPayButtonPrimaryVariant?"primary":"secondary",icon:X({imageFolder:"components/"})(`${x}lock`)}))};W.defaultProps=l;export{W as default};
//# sourceMappingURL=CardInput.js.map
