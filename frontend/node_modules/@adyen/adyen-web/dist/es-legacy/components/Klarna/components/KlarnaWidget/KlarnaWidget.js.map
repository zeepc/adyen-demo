{"version":3,"file":"KlarnaWidget.js","sources":["../../../../../../src/components/Klarna/components/KlarnaWidget/KlarnaWidget.tsx"],"sourcesContent":["import { h } from 'preact';\nimport { useEffect, useRef, useState, useCallback } from 'preact/hooks';\nimport Script from '../../../../utils/Script';\nimport { KLARNA_WIDGET_URL, KLARNA_REFUSED_RESULT_CODE } from '../../constants';\nimport type { KlarnaWidgetAuthorizeResponse, KlarnaWidgetProps } from '../../types';\nimport './KlarnaWidget.scss';\nimport useAnalytics from '../../../../core/Analytics/useAnalytics';\n\nexport function KlarnaWidget({ sdkData, paymentMethodType, widgetInitializationTime, payButton, ...props }: KlarnaWidgetProps) {\n    const klarnaWidgetRef = useRef(null);\n    const [status, setStatus] = useState('ready');\n    const { analytics } = useAnalytics();\n\n    const handleError = useCallback(() => {\n        setStatus('error');\n        props.onComplete({\n            data: {\n                paymentData: props.paymentData,\n                details: { resultCode: KLARNA_REFUSED_RESULT_CODE }\n            }\n        });\n    }, [props.paymentData, props.onComplete]);\n\n    const initializeKlarnaWidget = useCallback(() => {\n        window.Klarna.Payments.init({\n            client_token: sdkData.client_token\n        });\n\n        window.Klarna.Payments.load(\n            {\n                container: klarnaWidgetRef.current,\n                payment_method_category: sdkData.payment_method_category\n            },\n            function (res: { show_form: boolean; error: unknown }) {\n                // If show_form: true is received together with an error, something fixable is wrong and the consumer\n                // needs to take action before moving forward\n                // If show_form: false, the payment method in the loaded widget will not be offered for this order\n                // based on Klarnaâ€™s pre-assessment.\n                if (!res.show_form || !!res.error) {\n                    handleError();\n                } else {\n                    props.onLoaded();\n                }\n            }\n        );\n    }, [sdkData.client_token, sdkData.payment_method_category]);\n\n    const authorizeKlarna = useCallback(() => {\n        setStatus('loading');\n        try {\n            window.Klarna.Payments.authorize(\n                {\n                    payment_method_category: sdkData.payment_method_category\n                },\n                function (res: KlarnaWidgetAuthorizeResponse) {\n                    if (res.approved === true && res.show_form === true) {\n                        // Klarna has approved the authorization of credit for this order.\n                        setStatus('success');\n                        props.onComplete({\n                            data: {\n                                paymentData: props.paymentData,\n                                details: {\n                                    authorization_token: res.authorization_token\n                                }\n                            }\n                        });\n                    } else if (!res.approved && res.show_form === true) {\n                        // Fixable error\n                        setStatus('ready');\n                        props.onError(res);\n                    } else {\n                        // The purchase is declined. The widget should be hidden and the user\n                        // should select another payment method.\n                        handleError();\n                    }\n                }\n            );\n        } catch (e) {\n            handleError();\n        }\n    }, [sdkData.payment_method_category, props.onComplete, props.onError]);\n\n    // Workaround: See ADR-0001-uielement-keyboard-event-propagation-workaround\n    const handleKeyDown = (e: h.JSX.TargetedKeyboardEvent<HTMLButtonElement>) => {\n        if (e.key === 'Enter' || e.code === 'Enter') {\n            e.preventDefault();\n            authorizeKlarna();\n        }\n    };\n\n    /**\n     * Initializes Klarna SDK if it is already available and reinitialize\n     * it when the init time refreshes\n     */\n    useEffect(() => {\n        const isKlarnaAvailable = window.Klarna?.Payments?.init;\n        if (isKlarnaAvailable) {\n            initializeKlarnaWidget();\n        }\n    }, [widgetInitializationTime]);\n\n    useEffect(() => {\n        window.klarnaAsyncCallback = function () {\n            initializeKlarnaWidget();\n        };\n        const script = new Script({\n            src: KLARNA_WIDGET_URL,\n            component: 'klarna',\n            analytics\n        });\n\n        void script.load();\n\n        return () => {\n            script.remove();\n        };\n    }, [initializeKlarnaWidget, analytics]);\n\n    if (status !== 'error' && status !== 'success') {\n        return (\n            <div className=\"adyen-checkout__klarna-widget\">\n                <div ref={klarnaWidgetRef} />\n                {payButton({\n                    status,\n                    disabled: status === 'loading',\n                    onClick: authorizeKlarna,\n                    onKeyDown: handleKeyDown\n                })}\n            </div>\n        );\n    }\n\n    return null;\n}\n"],"names":["KlarnaWidget","_0","sdkData","paymentMethodType","widgetInitializationTime","payButton","props","klarnaWidgetRef","useRef","status","setStatus","useState","analytics","useAnalytics","handleError","useCallback","onComplete","data","paymentData","details","resultCode","KLARNA_REFUSED_RESULT_CODE","initializeKlarnaWidget","window","Klarna","Payments","init","client_token","load","container","current","payment_method_category","res","show_form","error","onLoaded","authorizeKlarna","authorize","approved","authorization_token","onError","e","handleKeyDown","key","code","preventDefault","useEffect","klarnaAsyncCallback","script","Script","src","KLARNA_WIDGET_URL","component","remove","h","div","className","ref","disabled","onClick","onKeyDown"],"mappings":"++BAQO,SAASA,EAAaC,OAAAC,QAAEA,EAAOC,kBAAEA,EAAiBC,yBAAEA,EAAwBC,UAAEA,GAAwCJ,EAA1BK,EAAAA,EAAAA,EAAAA,wEAC/F,MAAMC,EAAkBC,EAAO,OACxBC,EAAQC,GAAaC,EAAS,UAC/BC,UAAEA,GAAcC,IAEhBC,EAAcC,EAAY,KAC5BL,EAAU,SACVJ,EAAMU,WAAW,CACbC,KAAM,CACFC,YAAaZ,EAAMY,YACnBC,QAAS,CAAEC,WAAYC,OAGhC,CAACf,EAAMY,YAAaZ,EAAMU,aAEvBM,EAAyBP,EAAY,KACvCQ,OAAOC,OAAOC,SAASC,KAAK,CACxBC,aAAczB,EAAQyB,eAG1BJ,OAAOC,OAAOC,SAASG,KACnB,CACIC,UAAWtB,EAAgBuB,QAC3BC,wBAAyB7B,EAAQ6B,yBAErC,SAAUC,IAKDA,EAAIC,WAAeD,EAAIE,MACxBpB,IAEAR,EAAM6B,UAEd,IAEL,CAACjC,EAAQyB,aAAczB,EAAQ6B,0BAE5BK,EAAkBrB,EAAY,KAChCL,EAAU,WACV,IACIa,OAAOC,OAAOC,SAASY,UACnB,CACIN,wBAAyB7B,EAAQ6B,yBAErC,SAAUC,IACe,IAAjBA,EAAIM,WAAuC,IAAlBN,EAAIC,WAE7BvB,EAAU,WACVJ,EAAMU,WAAW,CACbC,KAAM,CACFC,YAAaZ,EAAMY,YACnBC,QAAS,CACLoB,oBAAqBP,EAAIO,yBAI7BP,EAAIM,WAA8B,IAAlBN,EAAIC,UAO5BnB,KALAJ,EAAU,SACVJ,EAAMkC,QAAQR,GAMtB,EAER,CAAE,MAAOS,GACL3B,GACJ,GACD,CAACZ,EAAQ6B,wBAAyBzB,EAAMU,WAAYV,EAAMkC,UAGvDE,EAAiBD,IACL,UAAVA,EAAEE,KAA8B,UAAXF,EAAEG,OACvBH,EAAEI,iBACFT,MAgCR,OAxBAU,EAAU,SACoBvB,EAAAA,GAAa,QAAbA,EAAAA,OAAOC,kBAAPD,GAAuB,QAAvBA,EAAAA,EAAeE,oBAAfF,OAAAA,EAAAA,EAAyBG,OAE/CJ,KAEL,CAAClB,IAEJ0C,EAAU,KACNvB,OAAOwB,oBAAsB,WACzBzB,GACJ,EACA,MAAM0B,EAAS,IAAIC,EAAO,CACtBC,IAAKC,EACLC,UAAW,SACXxC,cAKJ,OAFKoC,EAAOpB,OAEL,KACHoB,EAAOK,WAEZ,CAAC/B,EAAwBV,IAEb,UAAXH,GAAiC,YAAXA,EAElB6C,EAACC,MAAAA,CAAIC,UAAU,iCACXF,EAACC,MAAAA,CAAIE,IAAKlD,IACTF,EAAU,CACPI,SACAiD,SAAqB,YAAXjD,EACVkD,QAASvB,EACTwB,UAAWlB,KAMpB,IACX"}