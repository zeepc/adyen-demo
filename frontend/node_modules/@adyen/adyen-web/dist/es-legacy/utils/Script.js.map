{"version":3,"file":"Script.js","sources":["../../../src/utils/Script.ts"],"sourcesContent":["import AdyenCheckoutError from '../core/Errors/AdyenCheckoutError';\nimport { AnalyticsInfoEvent, InfoEventType } from '../core/Analytics/events/AnalyticsInfoEvent';\nimport type { IAnalytics } from '../core/Analytics/Analytics';\n\ninterface IScript {\n    load(): Promise<void>;\n    remove(): void;\n}\n\ninterface IScriptProps {\n    src: string;\n    component: string;\n    analytics: IAnalytics;\n    node?: string;\n    attributes?: Partial<HTMLScriptElement>;\n    dataAttributes?: Record<string, string | undefined>;\n}\n\n// Returns Base URL of the resource without any query parameters (e.g. merchant ID, token, etc). Used for Analytics\nfunction getBaseURL(src: string): string {\n    const url = new URL(src);\n    return url.origin + url.pathname;\n}\n\nclass Script implements IScript {\n    private readonly src: string;\n    private readonly component: string;\n    private readonly node: string;\n    private readonly attributes: Partial<HTMLScriptElement>;\n    private readonly dataAttributes: Record<string, string | undefined>;\n    private readonly analytics: IAnalytics;\n    private readonly baseUrl: string;\n\n    private script: HTMLScriptElement;\n    private loadPromise: Promise<void> | null = null;\n    private rejectLoadPromise: (reason?: any) => void | null = null;\n    private resolveLoadScript: (() => void) | null = null;\n    private rejectLoadScript: ((reason?: any) => void) | null = null;\n\n    private readonly handleOnLoad = () => {\n        this.script?.setAttribute('data-script-loaded', 'true');\n        this.cleanupListeners();\n        this.resolveLoadScript?.();\n    };\n\n    private readonly handleOnError = (errorEvent: ErrorEvent) => {\n        this.cleanupListeners();\n        const error = new AdyenCheckoutError(\n            'SCRIPT_ERROR',\n            `Unable to load script ${this.src}.${errorEvent?.message && `Message: ${errorEvent.message}`}`,\n            {\n                cause: errorEvent?.error || errorEvent\n            }\n        );\n        this.rejectLoadScript?.(error);\n    };\n\n    public static readonly RETRY_DELAY = 1000;\n    public static readonly MAX_NUMBER_OF_RETRIES = 3;\n\n    constructor({ src, component, node = 'body', attributes, dataAttributes, analytics }: IScriptProps) {\n        this.src = src;\n        this.component = component;\n        this.node = node;\n        this.attributes = attributes;\n        this.dataAttributes = dataAttributes;\n        this.analytics = analytics;\n        this.baseUrl = getBaseURL(this.src);\n    }\n\n    public load = (): Promise<void> => {\n        if (this.loadPromise !== null) {\n            if (process.env.NODE_ENV === 'development') console.warn(`[Warning] script.load called more than once for ${this.src}`);\n            return this.loadPromise;\n        }\n\n        this.loadPromise = new Promise((resolve, reject) => {\n            this.rejectLoadPromise = reject;\n            let attempts = 0;\n\n            this.trackEvent(InfoEventType.sdkDownloadInitiated);\n\n            const loadScriptWithRetry = async (): Promise<void> => {\n                try {\n                    attempts++;\n                    await this.loadScript();\n                    this.trackEvent(InfoEventType.sdkDownloadCompleted);\n                    resolve();\n                } catch (error: unknown) {\n                    if (this.loadPromise === null) {\n                        return;\n                    }\n\n                    this.trackEvent(InfoEventType.sdkDownloadFailed);\n\n                    this.removeScript();\n\n                    if (attempts < Script.MAX_NUMBER_OF_RETRIES) {\n                        setTimeout(() => void loadScriptWithRetry(), Script.RETRY_DELAY);\n                    } else {\n                        this.trackEvent(InfoEventType.sdkDownloadAborted);\n                        this.loadPromise = null;\n                        this.rejectLoadPromise = null;\n                        reject(error);\n                    }\n                }\n            };\n\n            void loadScriptWithRetry();\n        });\n\n        return this.loadPromise;\n    };\n\n    public remove = () => {\n        this.rejectLoadPromise?.(new AdyenCheckoutError('CANCEL', 'Script loading cancelled.'));\n        this.removeScript();\n        this.loadPromise = null;\n    };\n\n    private removeScript() {\n        this.cleanupListeners();\n        this.script?.parentNode?.removeChild(this.script);\n        this.script = null;\n    }\n\n    private cleanupListeners() {\n        if (!this.script) return;\n        this.script.removeEventListener('load', this.handleOnLoad);\n        this.script.removeEventListener('error', this.handleOnError);\n    }\n\n    private attachListeners() {\n        if (!this.script) return;\n        this.cleanupListeners();\n        this.script.addEventListener('load', this.handleOnLoad);\n        this.script.addEventListener('error', this.handleOnError);\n    }\n\n    private loadScript(): Promise<void> {\n        return new Promise((resolve, reject) => {\n            const scriptContainer = document.querySelector(this.node);\n\n            if (!scriptContainer) {\n                reject(new AdyenCheckoutError('SCRIPT_ERROR', `Unable to find script container node: ${this.node}`));\n                return;\n            }\n\n            this.resolveLoadScript = resolve;\n            this.rejectLoadScript = reject;\n\n            this.script = scriptContainer.querySelector(`script[src=\"${this.src}\"]`);\n\n            // Script element exists in the browser and is already loaded\n            if (this.script?.getAttribute('data-script-loaded')) {\n                this.resolveLoadScript();\n                return;\n            }\n\n            // Script element exists in the browser, but it is not loaded yet\n            // Use-case:  Multiple PayPal standalone components being loaded in different parts of the screen.\n            if (this.script) {\n                this.attachListeners();\n                return;\n            }\n\n            // Script element doesn't exist in the browser, so we create it and append to the DOM tree\n            this.script = document.createElement('script');\n\n            Object.assign(this.script, this.attributes);\n            Object.assign(this.script.dataset, this.dataAttributes);\n\n            this.script.src = this.src;\n            this.script.async = true;\n\n            this.attachListeners();\n\n            scriptContainer.appendChild(this.script);\n        });\n    }\n\n    private trackEvent(eventType: InfoEventType) {\n        const event = new AnalyticsInfoEvent({\n            type: eventType,\n            component: this.component,\n            cdnUrl: this.baseUrl\n        });\n        this.analytics?.sendAnalytics(event);\n    }\n}\n\nexport default Script;\n"],"names":["Script","removeScript","_this_script_parentNode","_this_script","this","cleanupListeners","script","parentNode","removeChild","removeEventListener","handleOnLoad","handleOnError","attachListeners","addEventListener","loadScript","Promise","resolve","reject","scriptContainer","document","querySelector","node","resolveLoadScript","rejectLoadScript","src","getAttribute","createElement","Object","assign","attributes","dataset","dataAttributes","async","appendChild","AdyenCheckoutError","trackEvent","eventType","_this_analytics","event","AnalyticsInfoEvent","type","component","cdnUrl","baseUrl","analytics","sendAnalytics","constructor","_define_property","loadPromise","rejectLoadPromise","_this_resolveLoadScript","setAttribute","call","errorEvent","_this_rejectLoadScript","error","message","cause","load","attempts","InfoEventType","sdkDownloadInitiated","loadScriptWithRetry","sdkDownloadCompleted","sdkDownloadFailed","MAX_NUMBER_OF_RETRIES","setTimeout","RETRY_DELAY","sdkDownloadAborted","remove","_this_rejectLoadPromise","url","URL","origin","pathname","getBaseURL"],"mappings":"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"}