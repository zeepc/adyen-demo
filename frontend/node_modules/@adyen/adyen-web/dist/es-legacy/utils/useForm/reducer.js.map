{"version":3,"file":"reducer.js","sources":["../../../../src/utils/useForm/reducer.ts"],"sourcesContent":["const omitKeys = (obj, omit) =>\n    Object.keys(obj)\n        .filter(k => !omit.includes(k))\n        .reduce((a, c) => {\n            a[c] = obj[c];\n            return a;\n        }, {});\n\nconst addKeys = (obj, add, initialValue, defaultData, pendingData) =>\n    add.reduce((a, c) => ({ ...a, [c]: a[c] ?? pendingData?.[c] ?? defaultData?.[c] ?? initialValue }), obj);\n\n/**\n * Processes default data and sets as default in state\n */\nexport function init({ schema, defaultData, processField, fieldProblems }) {\n    const getProcessedState = fieldKey => {\n        if (typeof defaultData[fieldKey] === 'undefined')\n            return { valid: false, errors: null, data: null, fieldProblems: fieldProblems?.[fieldKey] ?? null };\n\n        const [formattedValue, validationResult] = processField(\n            { key: fieldKey, value: defaultData[fieldKey], mode: 'blur' },\n            { state: { data: defaultData } }\n        );\n\n        return {\n            valid: (validationResult.isValid && !fieldProblems?.[fieldKey]) || false,\n            errors: validationResult.hasError() ? validationResult.getError() : null,\n            data: formattedValue,\n            fieldProblems: fieldProblems?.[fieldKey] ?? null\n        };\n    };\n\n    const formData = schema.reduce(\n        (acc: any, fieldKey) => {\n            const { valid, errors, data, fieldProblems } = getProcessedState(fieldKey);\n\n            return {\n                valid: { ...acc.valid, [fieldKey]: valid },\n                errors: { ...acc.errors, [fieldKey]: errors },\n                data: { ...acc.data, [fieldKey]: data },\n                fieldProblems: { ...acc.fieldProblems, [fieldKey]: fieldProblems }\n            };\n        },\n        { data: {}, valid: {}, errors: {}, fieldProblems: {} }\n    );\n\n    return {\n        schema,\n        data: formData.data,\n        valid: formData.valid,\n        errors: formData.errors,\n        fieldProblems: formData.fieldProblems\n    };\n}\n\nexport function getReducer(processField) {\n    return function reducer(state, { type, key, value, mode, schema, defaultData, formValue, selectedSchema, fieldProblems, data }) {\n        const validationSchema: string[] = selectedSchema || state.schema;\n\n        switch (type) {\n            case 'setData': {\n                return { ...state, data: { ...state['data'], [key]: value } };\n            }\n            case 'mergeData': {\n                return { ...state, data: { ...state['data'], ...data } };\n            }\n            case 'setValid': {\n                return { ...state, valid: { ...state['valid'], [key]: value } };\n            }\n            case 'setErrors': {\n                return { ...state, errors: { ...state['errors'], [key]: value } };\n            }\n            case 'setFieldProblems': {\n                return (\n                    state?.schema?.reduce(\n                        (acc, key) => ({\n                            ...acc,\n                            fieldProblems: { ...state['fieldProblems'], [key]: fieldProblems?.[key] ?? null },\n                            valid: { ...state['valid'], [key]: state['valid']?.[key] && !fieldProblems[key] }\n                        }),\n                        state\n                    ) ?? state\n                );\n            }\n            case 'updateField': {\n                const [formattedValue, validation] = processField({ key, value, mode }, { state });\n                const oldValue = state.data[key];\n                const fieldProblems = { ...state.fieldProblems };\n                if (oldValue !== formattedValue) {\n                    fieldProblems[key] = null;\n                }\n                return {\n                    ...state,\n                    data: { ...state['data'], [key]: formattedValue },\n                    errors: { ...state['errors'], [key]: validation.hasError() ? validation.getError() : null },\n                    valid: { ...state['valid'], [key]: (validation.isValid && !fieldProblems[key]) || false },\n                    fieldProblems\n                };\n            }\n            case 'mergeForm': {\n                // To provide a uniform result from forms even if there are multiple levels of nested forms are present\n                const mergedState = {\n                    ...state,\n                    data: { ...state['data'], ...formValue['data'] },\n                    errors: { ...state['errors'], ...formValue['errors'] },\n                    valid: { ...state['valid'], ...formValue['valid'] },\n                    fieldProblems: { ...state['fieldProblems'], ...formValue['fieldProblems'] }\n                };\n                if (mergedState['valid']) {\n                    mergedState.isValid = Object.values(mergedState.valid).every(isValid => isValid);\n                }\n                return mergedState;\n            }\n            case 'setSchema': {\n                const defaultState = init({ schema, defaultData, processField, fieldProblems });\n                const removedSchemaFields = state.schema.filter(x => !schema.includes(x));\n                const newSchemaFields = schema.filter(x => !state.schema.includes(x));\n\n                // if we remove a key from the schema we also lost the latest value of the field\n                // to prevent this we have to store the value in a local state so we can recover it when the key is re-added to the schema\n                const local = {\n                    data: omitKeys(state.data, newSchemaFields),\n                    errors: omitKeys(state.errors, newSchemaFields),\n                    valid: omitKeys(state.valid, newSchemaFields)\n                };\n\n                // reindex data and validation according to the new schema\n                const data = addKeys(omitKeys(state.data, removedSchemaFields), newSchemaFields, null, defaultState.data, state.local?.data);\n                const valid = addKeys(omitKeys(state.valid, removedSchemaFields), newSchemaFields, false, defaultState.valid, state.local?.valid);\n                const errors = addKeys(omitKeys(state.errors, removedSchemaFields), newSchemaFields, null, defaultState.errors, state.local?.errors);\n\n                return { ...state, schema, data, valid, errors, local };\n            }\n            case 'validateForm': {\n                const formValidation = validationSchema.reduce(\n                    (acc, cur) => {\n                        const [, validation] = processField({ key: cur, value: state.data[cur], mode: 'blur' }, { state });\n                        return {\n                            valid: { ...acc['valid'], [cur]: (validation.isValid && !state.fieldProblems[cur]) || false },\n                            errors: { ...acc['errors'], [cur]: validation.hasError(true) ? validation.getError(true) : null }\n                        };\n                    },\n                    { valid: state.valid, errors: state.errors }\n                );\n\n                return { ...state, valid: formValidation.valid, errors: formValidation.errors };\n            }\n            default:\n                throw new Error('Undefined useForm action');\n        }\n    };\n}\n"],"names":["omitKeys","obj","omit","Object","keys","filter","k","includes","reduce","a","c","addKeys","add","initialValue","defaultData","pendingData","_object_spread_props","_object_spread","init","schema","processField","fieldProblems","getProcessedState","fieldKey","valid","errors","data","_ref","formattedValue","validationResult","key","value","mode","state","isValid","hasError","getError","_ref1","formData","acc","getReducer","type","formValue","selectedSchema","validationSchema","validation","oldValue","mergedState","values","every","defaultState","removedSchemaFields","x","newSchemaFields","local","formValidation","cur","Error"],"mappings":"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"}